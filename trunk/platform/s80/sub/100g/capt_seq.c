#include "lolevel.h"
#include "platform.h"
#include "core.h"


static long *nrflag = (long*)0x6E10;

#include "../../../generic/capt_seq.c"

void __attribute__((naked,noinline)) sub_FF9580EC_my(long p)
{
    asm volatile (
		"STMFD	SP!, {R4,R5,LR}\n"
		"LDR	R3, =0x748FC\n"
		"LDR	R5, =0x6E0C\n"
		"SUB	SP, SP,	#4\n"
                "LDR    R1, =0xFFFFFFFF\n"
		"STR	R0, [R5]\n"
		"LDR	R0, [R3]\n"
		"BL	sub_FF81FD74\n"
		"BL	sub_FF95E3C0\n"
		"LDR	R0, [R0,#0x7C]\n"
		//"BL	nullsub_24\n"
		"BL	sub_FF958060\n"
         	"BL     wait_until_remote_button_is_released\n"
	    	"BL     capt_seq_hook_set_nr\n"
		"LDR	R3, =0x6E14\n"
		"LDR	R0, [R3]\n"
		"BL	sub_FF8A0224\n"
		"LDR	R3, =0x6E10\n"
		"LDR	R3, [R3]\n"
		"CMP	R3, #1\n"
		"MOV	R4, #0\n"
		"BNE	loc_FF958168\n"
		"BL	sub_FF952190\n"
		"LDR	R3, [R5]\n"
		"ADD	R3, R3,	R3,LSL#1\n"
		"ADD	R0, R0,	R3,LSL#5\n"
		"LDR	R0, [R0,#0x18]\n"
		"LDR	R1, =0xFF957E7C\n"
		"MOV	R2, R4\n"
		"LDR	R3, =0xFF957FD8\n"
		"STR	R4, [SP,#0x10-0x10]\n"
		"BL	sub_FF8B92D8\n"
		"B	loc_FF958218\n"
"loc_FF958168:\n"
		"CMP	R3, #2\n"
		"BNE	loc_FF9581E8\n"
		"BL	sub_FF952190\n"
		"LDR	R3, [R5]\n"
		"ADD	R3, R3,	R3,LSL#1\n"
		"ADD	R0, R0,	R3,LSL#5\n"
		"LDR	R0, [R0,#0x18]\n"
		"LDR	R1, =0xFF957E7C\n"
		"MOV	R2, R4\n"
		"LDR	R3, =0xFF958040\n"
		"STR	R4, [SP,#0x10-0x10]\n"
		"BL	sub_FF8B9350\n"
		"TST	R0, #1\n"
		"BNE	loc_FF958220\n"
		"MOV	R1, R4\n"
		"MOV	R0, #0x24\n"
		"BL	sub_FF9AB43C\n"
		"BL	sub_FF8B92CC\n"
		"BL	sub_FF952190\n"
		"LDR	R3, [R5]\n"
		"ADD	R3, R3,	R3,LSL#1\n"
		"ADD	R0, R0,	R3,LSL#5\n"
		"LDR	R0, [R0,#0x18]\n"
		"LDR	R1, =0xFF957FD8\n"
		"MOV	R2, R4\n"
		"BL	sub_FF8B9440\n"
		"TST	R0, #1\n"
		"BNE	loc_FF958220\n"
		"MOV	R0, #0x25\n"
		"MOV	R1, R4\n"
		"BL	sub_FF9AB43C\n"
		"B	loc_FF958238\n"
"loc_FF9581E8:\n"
		"CMP	R3, #3\n"
		"BNE	loc_FF958228\n"
		"BL	sub_FF952190\n"
		"LDR	R3, [R5]\n"
		"ADD	R3, R3,	R3,LSL#1\n"
		"ADD	R0, R0,	R3,LSL#5\n"
		"LDR	R0, [R0,#0x18]\n"
		"LDR	R1, =0xFF957E7C\n"
		"MOV	R2, R4\n"
		"LDR	R3, =0xFF957FD8\n"
		"STR	R4, [SP,#0x10-0x10]\n"
		"BL	sub_FF8B93C8\n"
"loc_FF958218:\n"
		"TST	R0, #1\n"
		"BEQ	loc_FF958238\n"
"loc_FF958220:\n"
		"MOV	R4, #0x1D\n"
		"B	loc_FF9582BC\n"
"loc_FF958228:\n"
		"MOV	R1, #0x12C\n"
		"LDR	R0, =0xFF9580DC\n"
		"ADD	R1, R1,	#2\n"
		"BL	sub_FF813A80\n"
"loc_FF958238:\n"
		"MOV	R0, #0xDE\n"
		"LDR	R1, =0x6E14\n"
		"MOV	R2, #4\n"
		"BL	sub_FF824438\n"
		"BL	sub_FF95C45C\n"
		"BL	sub_FF95E3C0\n"
		"LDRH	R3, [R0]\n"
		"CMP	R3, #5\n"
		"BEQ	loc_FF95828C\n"
		"BL	sub_FF95E3C0\n"
		"LDRH	R3, [R0,#0x88]\n"
		"CMP	R3, #3\n"
		"BEQ	loc_FF95828C\n"
		"BL	sub_FF952190\n"
		"LDR	R2, =0x6E0C\n"
		"LDR	R3, [R2]\n"
		"ADD	R3, R3,	R3,LSL#1\n"
		"ADD	R0, R0,	R3,LSL#5\n"
		"LDR	R2, [R0,#0xC]\n"
		"CMP	R2, #1\n"
		"BHI	loc_FF9582BC\n"
"loc_FF95828C:\n"
		"LDR	R3, =0x748FC\n"
		"MOV	R2, #0x2700\n"
		"LDR	R0, [R3]\n"
		"MOV	R1, #8\n"
		"ADD	R2, R2,	#0x10\n"
		"BL	sub_FF95EC1C\n"
		"CMP	R0, #0\n"
		"BEQ	loc_FF9582BC\n"
		"MOV	R1, #0x138\n"
		"LDR	R0, =0xFF9580DC\n"
		"ADD	R1, R1,	#3\n"
		"BL	sub_FF813A80\n"
"loc_FF9582BC:\n"
		"MOV	R0, R4\n"
		"ADD	SP, SP,	#4\n"
		"LDMFD	SP!, {R4,R5,PC}\n"

    );
}

void __attribute__((naked,noinline)) sub_FF954A30_my(long p)
{
    asm volatile (
                "STMFD   SP!, {R4,R5,LR}\n"
                "LDR     R5, [R0,#0xC]\n"
                "BL      sub_FF95E164\n"
                "CMP     R0, #0\n"
                "BNE     loc_FF954A48\n"
                "BL      sub_FF95E170\n"
"loc_FF954A48:\n"
		"MOV	R0, R5\n"
		"BL	sub_FF956E1C\n"
		"MOV	R0, R5\n"
		"BL	sub_FF956E5C\n"
		"TST	R0, #1\n"
		"MOV	R2, R5\n"
		"MOV	R1, #1\n"
		"BEQ	loc_FF954A70\n"
		"LDMFD	SP!, {R4,R5,LR}\n"
		"B	sub_FF952E48\n"
"loc_FF954A70:\n"
		"BL	sub_FF995864\n"
		"BL	sub_FF952190\n"
		"MOV	R4, R0\n"
		"BL	sub_FF824750\n"
		"ADD	R3, R5,	R5,LSL#1\n"
		"ADD	R4, R4,	R3,LSL#5\n"
		"STR	R0, [R4,#4]\n"
		"MOV	R0, R5\n"
		"BL	sub_FF958904\n"
		"BL	sub_FF9573C8\n"
		"BL	sub_FF95736C\n"
		"MOV	R0, R5\n"
		"BL	sub_FF9580EC_my\n"		// _my
		"BL     capt_seq_hook_raw_here\n"
		"MOV	R2, R5\n"
		"MOV	R1, #1\n"
		"BL	sub_FF952E48\n"
		"LDMFD	SP!, {R4,R5,LR}\n"
		"B	sub_FF9582EC\n"
    );
}

void __attribute__((naked,noinline)) capt_seq_task()
{
	asm volatile (
                 "STMFD   SP!, {R4,LR}\n"
                 "SUB     SP, SP, #4\n"
                 "MOV     R4, SP\n"
                 "B       loc_FF954F90\n"
"loc_FF954E3C:\n"
                 "LDR     R2, [SP,#0xC-0xC]\n"
                 "LDR     R3, [R2]\n"
                 "MOV     R0, R2\n"
                 "CMP     R3, #0x15\n"
                 "LDRLS   PC, [PC,R3,LSL#2]\n"
                 "B       loc_FF954F68\n"
                 ".long loc_FF954EAC\n"
                 ".long loc_FF954EB8\n"
                 ".long loc_FF954EC0\n"
                 ".long loc_FF954ED0\n"
                 ".long loc_FF954EC8\n"
                 ".long loc_FF954ED8\n"
                 ".long loc_FF954EE0\n"
                 ".long loc_FF954EEC\n"
                 ".long loc_FF954EF4\n"
                 ".long loc_FF954F00\n"
                 ".long loc_FF954F08\n"
                 ".long loc_FF954F10\n"
                 ".long loc_FF954F18\n"
                 ".long loc_FF954F20\n"
                 ".long loc_FF954F28\n"
                 ".long loc_FF954F34\n"
                 ".long loc_FF954F3C\n"
                 ".long loc_FF954F44\n"
                 ".long loc_FF954F4C\n"
                 ".long loc_FF954F58\n"
                 ".long loc_FF954F60\n"
                 ".long loc_FF954F78\n"
/*
"loc_FF954EAC:\n"
				 "BL      sub_FF9566B0\n" // SsPrepareSeq_c
                 //"BL      shooting_expo_param_override\n"  // +
                 "STMFD   SP!, {R1-R12,LR}\n"
                 "BL      captseq_hack_override_active\n" // returns 1 if tv or sv override in effect
                 "LDMFD   SP!, {R1-R12,LR}\n"
                 "STR     R0,[SP,#-4]!\n" // push return value
                 "BL      shooting_expo_param_override\n" // saves all regs
                 "BL      sub_FF952984\n"
                 "LDR     R0,[SP],#4\n" // pop override hack
                 "CMP     R0, #1\n"
                 "MOVEQ   R0, #0\n"
                 "STREQ   R0, [R4,#0x24]\n"  // fixes overrides behavior at short shutter press
                 //"BL      sub_FF952984\n"
//  this code added to avoid some incorrect behavior if overrides are used.
//  but it can cause some unexpected side effects. In this case, remove this code!
                 "LDR     R0, =ovr_disable\n"
                 "LDR     R0, [R0]\n"
                 "LDR     R0, [R0]\n"
                 "CMP     R0, #1\n"
                 "BEQ     locA\n"
                 "MOV     R0, #0\n"
                 "STR     R0, [R4,#0x24]\n"  // fixes overrides  behavior at short shutter press	
*/				 
"loc_FF954EAC:\n"
                 "BL      sub_FF9566B0\n"
		         "BL      shooting_expo_param_override\n" // +
                 "BL      sub_FF952984\n"
                 "B       loc_FF954F74\n"
"loc_FF954EB8:\n"
//"locA:\n"
                 "BL      sub_FF954A30_my\n"	// _my
                 "B       loc_FF954F74\n"
"loc_FF954EC0:\n"
                 "BL      sub_FF956E0C\n"
                 "B       loc_FF954F74\n"
"loc_FF954EC8:\n"
                 "BL      sub_FF9558B4\n"
                 "B       loc_FF954F74\n"
"loc_FF954ED0:\n"
                 "BL      sub_FF955910\n"
                 "B       loc_FF954F74\n"
"loc_FF954ED8:\n"
                 "BL      sub_FF955B74\n"
                 "B       loc_FF954F74\n"
"loc_FF954EE0:\n"
                 "BL      sub_FF9567A4\n"
                 "BL      sub_FF952984\n"
                 "B       loc_FF954F74\n"
"loc_FF954EEC:\n"
                 "BL      sub_FF954B20\n"
                 "B       loc_FF954F74\n"
"loc_FF954EF4:\n"
                 "BL      sub_FF95680C\n"
                 "BL      sub_FF952984\n"
                 "B       loc_FF954F74\n"
"loc_FF954F00:\n"
                 "BL      sub_FF955910\n"
                 "B       loc_FF954F74\n"
"loc_FF954F08:\n"
                 "BL      sub_FF957504\n"
                 "B       loc_FF954F74\n"
"loc_FF954F10:\n"
                 "BL      sub_FF95782C\n"
                 "B       loc_FF954F74\n"
"loc_FF954F18:\n"
                 "BL      sub_FF9578B8\n"
                 "B       loc_FF954F74\n"
"loc_FF954F20:\n"
                 "BL      sub_FF957970\n"
                 "B       loc_FF954F74\n"
"loc_FF954F28:\n"
                 "MOV     R0, #0\n"
                 "BL      sub_FF957A20\n"
                 "B       loc_FF954F74\n"
"loc_FF954F34:\n"
                 "BL      sub_FF957B70\n"
                 "B       loc_FF954F74\n"
"loc_FF954F3C:\n"
                 "BL      sub_FF957BE4\n"
                 "B       loc_FF954F74\n"
"loc_FF954F44:\n"
                 "BL      sub_FF957C9C\n"
                 "B       loc_FF954F74\n"
"loc_FF954F4C:\n"
                 "MOV     R0, #1\n"
                 "BL      sub_FF957A20\n"
                 "B       loc_FF954F74\n"
"loc_FF954F58:\n"
                 "BL      sub_FF957D6C\n"
                 "B       loc_FF954F74\n"
"loc_FF954F60:\n"
                 "BL      sub_FF957D98\n"
                 "B       loc_FF954F74\n"
"loc_FF954F68:\n"
                 "LDR     R0, =0xFF9547B4\n"
                 "MOV     R1, #0x2DC\n"
                 "BL      sub_FF813A80\n"
"loc_FF954F74:\n"
                 "LDR     R2, [SP,#0xC-0xC]\n"
"loc_FF954F78:\n"
                 "LDR     R3, =0x74884\n"
                 "LDR     R1, [R2,#4]\n"
                 "LDR     R0, [R3]\n"
                 "BL      sub_FF81FBD8\n"
                 "LDR     R0, [SP,#0xC-0xC]\n"
                 "BL      sub_FF954830\n"
"loc_FF954F90:\n"
                 "LDR     R3, =0x74888\n"
                 "MOV     R1, R4\n"
                 "LDR     R0, [R3]\n"
                 "MOV     R2, #0\n"
                 "BL      sub_FF820388\n"
                 "TST     R0, #1\n"
                 "BEQ     loc_FF954E3C\n"
                 "MOV     R1, #0x24C\n"
                 "LDR     R0, =0xFF9547B4\n"
                 "ADD     R1, R1, #1\n"
                 "BL      sub_FF813A80\n"
                 "BL      sub_FF821924\n"
                 "ADD     SP, SP, #4\n"
                 "LDMFD   SP!, {R4,PC}\n"

	);
}





