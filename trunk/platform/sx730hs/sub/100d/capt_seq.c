#include "lolevel.h"
#include "platform.h"
#include "core.h"

// debug
#define CAPTSEQ_DEBUG_LOG 1
extern void _LogCameraEvent(int id,const char *fmt,...);

#define USE_STUBS_NRFLAG 1
#define NR_AUTO (-1) // default value if NRTBL.SetDarkSubType not used is -1 (0 probalby works the same), set to enable auto

#ifdef CAPTSEQ_DEBUG_LOG

extern char *hook_raw_image_addr(void);

void log_capt_seq(int m)
{
    _LogCameraEvent(0x60,"cs m:%d rb:0x%08x i:%04d",
                    m,
                    hook_raw_image_addr(),
                    get_exposure_counter());
}
void log_capt_seq2(int m)
{
    _LogCameraEvent(0x60,"cs end m:%d rb:0x%08x i:%04d",
                    m,
                    hook_raw_image_addr(),
                    get_exposure_counter());
}
void log_capt_seq_override(void)
{
    _LogCameraEvent(0x60,"cs override rb:0x%08x i:%04d",
                    hook_raw_image_addr(),
                    get_exposure_counter());
}
#endif

#include "../../../generic/capt_seq.c"

// first paramter matches active_raw_buffer
// second is pointer to structure
extern int _captseq_raw_addr_init(int raw_index, char **ptr);
char *current_raw_addr;

void captseq_raw_addr_init_my(int raw_index,char **ptr) {
    _captseq_raw_addr_init(raw_index,ptr);
    current_raw_addr=*(ptr + 0x60/4); // @0xfc0f6010 [r4,#0x60]
#ifdef CAPTSEQ_DEBUG_LOG
    _LogCameraEvent(0x60,"rawinit i:0x%x p:0x%x v:0x%x",raw_index,ptr,current_raw_addr);
#endif
}

void clear_current_raw_addr(void) {
    current_raw_addr=NULL;
}

// -f=chdk -s=task_CaptSeq -c=183
void __attribute__((naked,noinline)) capt_seq_task() {
    asm volatile (
// task_CaptSeq 0xfc0f2b2f
"    push    {r3, r4, r5, r6, r7, lr}\n"
"    ldr     r4, =0x0003e6f8\n"
"    movs    r6, #0\n"
"    ldr     r5, =0x0000bfc8\n"
"loc_fc0f2b36:\n"
"    movs    r2, #0\n"
"    mov     r1, sp\n"
"    ldr     r0, [r5, #8]\n"
"    bl      sub_fc3446ae\n" // ReceiveMessageQueue
"    lsls    r0, r0, #0x1f\n"
"    beq     loc_fc0f2b58\n"
"    movw    r2, #0x453\n"
"    ldr     r1, =0xfc0f2778\n" //  *"SsShootTask.c"
"    movs    r0, #0\n"
"    bl      _DebugAssert\n"
"    bl      _ExitTask\n"
"    pop     {r3, r4, r5, r6, r7, pc}\n"
"loc_fc0f2b58:\n"
"    ldr     r0, [sp]\n"
"    ldr     r0, [r0]\n"
"    cmp     r0, #1\n"
"    beq     loc_fc0f2b74\n"
"    cmp     r0, #0x2d\n"
"    beq     loc_fc0f2b74\n"
"    cmp     r0, #0x2e\n"
"    beq     loc_fc0f2b74\n"
"    cmp     r0, #0x21\n"
"    beq     loc_fc0f2b74\n"
"    cmp     r0, #0x25\n"
"    beq     loc_fc0f2b74\n"
"    bl      sub_fc18ef68\n"
"loc_fc0f2b74:\n"
#ifdef CAPTSEQ_DEBUG_LOG
// debug message
"ldr     r0, [sp]\n"
"ldr     r0, [r0]\n"
"bl log_capt_seq\n"
#endif
"    ldr     r0, [sp]\n"
"    ldr     r1, [r0]\n"
"    cmp     r1, #0x37\n"
"    bhs     loc_fc0f2c5e\n"
"    tbb     [pc, r1]\n" // (jumptable r1 55 elements)
"branchtable_fc0f2b80:\n"
"    .byte((loc_fc0f2bb8 - branchtable_fc0f2b80) / 2)\n" // (case 0)
"    .byte((loc_fc0f2bce - branchtable_fc0f2b80) / 2)\n" // (case 1)
"    .byte((loc_fc0f2bd6 - branchtable_fc0f2b80) / 2)\n" // (case 2)
"    .byte((loc_fc0f2be4 - branchtable_fc0f2b80) / 2)\n" // (case 3)
"    .byte((loc_fc0f2bde - branchtable_fc0f2b80) / 2)\n" // (case 4)
"    .byte((loc_fc0f2bfc - branchtable_fc0f2b80) / 2)\n" // (case 5)
"    .byte((loc_fc0f2c02 - branchtable_fc0f2b80) / 2)\n" // (case 6)
"    .byte((loc_fc0f2c0c - branchtable_fc0f2b80) / 2)\n" // (case 7)
"    .byte((loc_fc0f2c14 - branchtable_fc0f2b80) / 2)\n" // (case 8)
"    .byte((loc_fc0f2c24 - branchtable_fc0f2b80) / 2)\n" // (case 9)
"    .byte((loc_fc0f2c2c - branchtable_fc0f2b80) / 2)\n" // (case 10)
"    .byte((loc_fc0f2c32 - branchtable_fc0f2b80) / 2)\n" // (case 11)
"    .byte((loc_fc0f2d22 - branchtable_fc0f2b80) / 2)\n" // (case 12)
"    .byte((loc_fc0f2c3a - branchtable_fc0f2b80) / 2)\n" // (case 13)
"    .byte((loc_fc0f2c40 - branchtable_fc0f2b80) / 2)\n" // (case 14)
"    .byte((loc_fc0f2c46 - branchtable_fc0f2b80) / 2)\n" // (case 15)
"    .byte((loc_fc0f2c4c - branchtable_fc0f2b80) / 2)\n" // (case 16)
"    .byte((loc_fc0f2c52 - branchtable_fc0f2b80) / 2)\n" // (case 17)
"    .byte((loc_fc0f2c58 - branchtable_fc0f2b80) / 2)\n" // (case 18)
"    .byte((loc_fc0f2c60 - branchtable_fc0f2b80) / 2)\n" // (case 19)
"    .byte((loc_fc0f2c66 - branchtable_fc0f2b80) / 2)\n" // (case 20)
"    .byte((loc_fc0f2c6c - branchtable_fc0f2b80) / 2)\n" // (case 21)
"    .byte((loc_fc0f2c70 - branchtable_fc0f2b80) / 2)\n" // (case 22)
"    .byte((loc_fc0f2c76 - branchtable_fc0f2b80) / 2)\n" // (case 23)
"    .byte((loc_fc0f2c7c - branchtable_fc0f2b80) / 2)\n" // (case 24)
"    .byte((loc_fc0f2c82 - branchtable_fc0f2b80) / 2)\n" // (case 25)
"    .byte((loc_fc0f2c86 - branchtable_fc0f2b80) / 2)\n" // (case 26)
"    .byte((loc_fc0f2c8a - branchtable_fc0f2b80) / 2)\n" // (case 27)
"    .byte((loc_fc0f2c92 - branchtable_fc0f2b80) / 2)\n" // (case 28)
"    .byte((loc_fc0f2c9a - branchtable_fc0f2b80) / 2)\n" // (case 29)
"    .byte((loc_fc0f2d22 - branchtable_fc0f2b80) / 2)\n" // (case 30)
"    .byte((loc_fc0f2ca2 - branchtable_fc0f2b80) / 2)\n" // (case 31)
"    .byte((loc_fc0f2ca8 - branchtable_fc0f2b80) / 2)\n" // (case 32)
"    .byte((loc_fc0f2cac - branchtable_fc0f2b80) / 2)\n" // (case 33)
"    .byte((loc_fc0f2cb4 - branchtable_fc0f2b80) / 2)\n" // (case 34)
"    .byte((loc_fc0f2d22 - branchtable_fc0f2b80) / 2)\n" // (case 35)
"    .byte((loc_fc0f2cba - branchtable_fc0f2b80) / 2)\n" // (case 36)
"    .byte((loc_fc0f2cc0 - branchtable_fc0f2b80) / 2)\n" // (case 37)
"    .byte((loc_fc0f2cc6 - branchtable_fc0f2b80) / 2)\n" // (case 38)
"    .byte((loc_fc0f2ccc - branchtable_fc0f2b80) / 2)\n" // (case 39)
"    .byte((loc_fc0f2cd2 - branchtable_fc0f2b80) / 2)\n" // (case 40)
"    .byte((loc_fc0f2cda - branchtable_fc0f2b80) / 2)\n" // (case 41)
"    .byte((loc_fc0f2ce0 - branchtable_fc0f2b80) / 2)\n" // (case 42)
"    .byte((loc_fc0f2d22 - branchtable_fc0f2b80) / 2)\n" // (case 43)
"    .byte((loc_fc0f2d04 - branchtable_fc0f2b80) / 2)\n" // (case 44)
"    .byte((loc_fc0f2d0a - branchtable_fc0f2b80) / 2)\n" // (case 45)
"    .byte((loc_fc0f2d16 - branchtable_fc0f2b80) / 2)\n" // (case 46)
"    .byte((loc_fc0f2d22 - branchtable_fc0f2b80) / 2)\n" // (case 47)
"    .byte((loc_fc0f2d30 - branchtable_fc0f2b80) / 2)\n" // (case 48)
"    .byte((loc_fc0f2d22 - branchtable_fc0f2b80) / 2)\n" // (case 49)
"    .byte((loc_fc0f2d22 - branchtable_fc0f2b80) / 2)\n" // (case 50)
"    .byte((loc_fc0f2d22 - branchtable_fc0f2b80) / 2)\n" // (case 51)
"    .byte((loc_fc0f2d22 - branchtable_fc0f2b80) / 2)\n" // (case 52)
"    .byte((loc_fc0f2d22 - branchtable_fc0f2b80) / 2)\n" // (case 53)
"    .byte((loc_fc0f2d1c - branchtable_fc0f2b80) / 2)\n" // (case 54)
".align 1\n"
"loc_fc0f2bb8:\n"  // case 0: preshoot, quick press shoot
"    ldr     r0, [r0, #0xc]\n"
"    bl      sub_fc0f31e8\n"
#ifdef CAPTSEQ_DEBUG_LOG
"bl log_capt_seq_override\n"
#endif
"    BL      clear_current_raw_addr\n" // +
"    BL      shooting_expo_param_override\n" // +
"    bl      sub_fc0f054e\n"
"    ldr     r0, [r4, #0x24]\n"
"    cmp     r0, #0\n"
"    beq     loc_fc0f2bcc\n"
//"    bl      sub_fc18e1b0\n"
"    bl      sub_fc18e1b0_my\n" // ->
"loc_fc0f2bcc:\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2bce:\n" // case 1: normal shoot
"    ldr     r0, [r0, #0x10]\n"
//"    bl      sub_fc18e126\n"
"    bl      sub_fc18e126_my\n" // ->
"    b       loc_fc0f2d30\n"
"loc_fc0f2bd6:\n"
"    movs    r0, #1\n"
"    bl      sub_fc0f35b2\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2bde:\n"
"    bl      sub_fc0f2e32\n"
"    b       loc_fc0f2bea\n"
"loc_fc0f2be4:\n"
"    ldr     r0, [r0, #0xc]\n"
"    bl      sub_fc0f3196\n"
"loc_fc0f2bea:\n"
"    str     r6, [r4, #0x24]\n"
"    b       loc_fc0f2d30\n"
".ltorg\n"
// firmware had literal pool here
// 00 00 
// 14 e9 03 00
// f8 e6 03 00
// c8 bf 00 00
"loc_fc0f2bfc:\n"
"    bl      sub_fc0f319e\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c02:\n"
"    bl      sub_fc0f34d2\n"
"    bl      sub_fc0f054e\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c0c:\n"
"    ldr     r0, [r0, #0x10]\n"
"    bl      sub_fc18e244\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c14:\n"
"    bl      sub_fc0f3534\n"
"    bl      sub_fc0f054e\n"
"    movs    r0, #0\n"
"    bl      sub_fc27eada\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c24:\n"
"    ldr     r0, [r4, #0x50]\n"
"    bl      sub_fc0f49c4\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c2c:\n"
"    bl      sub_fc0f4c70\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c32:\n"
"    ldr     r0, [r0, #0xc]\n"
"    bl      sub_fc0f4cbc\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c3a:\n"
"    bl      sub_fc0f4e10\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c40:\n"
"    bl      sub_fc0f51d8\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c46:\n"
"    bl      sub_fc0f526e\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c4c:\n"
"    bl      sub_fc18cb74\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c52:\n"
"    bl      sub_fc18ccda\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c58:\n"
"    bl      sub_fc18cd50\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c5e:\n"
"    b       loc_fc0f2d22\n"
"loc_fc0f2c60:\n"
"    bl      sub_fc18cdd8\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c66:\n"
"    bl      sub_fc18ce7e\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c6c:\n"
"    movs    r0, #0\n"
"    b       loc_fc0f2c8c\n"
"loc_fc0f2c70:\n"
"    bl      sub_fc18d17c\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c76:\n"
"    bl      sub_fc18d1ce\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c7c:\n"
"    bl      sub_fc18d1d2\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c82:\n"
"    movs    r0, #0\n"
"    b       loc_fc0f2c94\n"
"loc_fc0f2c86:\n"
"    movs    r0, #0\n"
"    b       loc_fc0f2c9c\n"
"loc_fc0f2c8a:\n"
"    movs    r0, #1\n"
"loc_fc0f2c8c:\n"
"    bl      sub_fc18d068\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c92:\n"
"    movs    r0, #1\n"
"loc_fc0f2c94:\n"
"    bl      sub_fc18d1e4\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2c9a:\n"
"    movs    r0, #1\n"
"loc_fc0f2c9c:\n"
"    bl      sub_fc18d282\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2ca2:\n"
"    bl      sub_fc0f3684\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2ca8:\n"
"    movs    r0, #0\n"
"    b       loc_fc0f2cae\n"
"loc_fc0f2cac:\n"
"    ldr     r0, [r0, #0xc]\n"
"loc_fc0f2cae:\n"
"    bl      sub_fc0f3700\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2cb4:\n"
"    bl      sub_fc18cf98\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2cba:\n"
"    bl      sub_fc18cff8\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2cc0:\n"
"    bl      sub_fc18e942\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2cc6:\n"
"    bl      sub_fc0f81be\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2ccc:\n"
"    bl      sub_fc0f8278\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2cd2:\n"
"    ldr     r0, [r0, #0xc]\n"
"    bl      sub_fc18d35c\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2cda:\n"
"    bl      sub_fc18d3c4\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2ce0:\n"
"    bl      sub_fc0fa17c\n"
"    ldrh.w  r0, [r4, #0x1b8]\n"
"    cmp     r0, #4\n"
"    beq     loc_fc0f2cf6\n"
"    ldrh    r0, [r4]\n"
"    sub.w   r1, r0, #0x4200\n"
"    subs    r1, #0x38\n"
"    bne     loc_fc0f2d30\n"
"loc_fc0f2cf6:\n"
"    bl      sub_fc0f8278\n"
"    bl      sub_fc0f87be\n"
"    bl      sub_fc0f861c\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2d04:\n"
"    movs    r2, #0\n"
"    movs    r1, #0x12\n"
"    b       loc_fc0f2d0e\n"
"loc_fc0f2d0a:\n"
"    movs    r2, #0\n"
"    movs    r1, #0x10\n"
"loc_fc0f2d0e:\n"
"    movs    r0, #0\n"
"    bl      sub_fc0f1134\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2d16:\n"
"    movs    r2, #0\n"
"    movs    r1, #0x11\n"
"    b       loc_fc0f2d0e\n"
"loc_fc0f2d1c:\n"
"    bl      sub_fc0f4910\n"
"    b       loc_fc0f2d30\n"
"loc_fc0f2d22:\n"
"    movw    r2, #0x58f\n"
"    ldr     r1, =0xfc0f2778\n" //  *"SsShootTask.c"
"    movs    r0, #0\n"
"    bl      _DebugAssert\n"
"loc_fc0f2d30:\n"
// debug after message handled
#ifdef CAPTSEQ_DEBUG_LOG
"ldr     r0, [sp]\n"
"ldr     r0, [r0]\n"
"bl log_capt_seq2\n"
#endif
"    ldr     r0, [sp]\n"
"    ldr     r1, [r0, #4]\n"
"    ldr     r0, [r5, #4]\n"
"    bl      _SetEventFlag\n"
"    ldr     r7, [sp]\n"
"    ldr     r0, [r7, #8]\n"
"    cbnz    r0, loc_fc0f2d4e\n"
"    movw    r2, #0x102\n"
"    ldr     r1, =0xfc0f2778\n" //  *"SsShootTask.c"
"    movs    r0, #0\n"
"    bl      _DebugAssert\n"
"loc_fc0f2d4e:\n"
"    str     r6, [r7, #8]\n"
"    b       loc_fc0f2b36\n"
".ltorg\n"
    );
}
// -f=chdk -s=0xfc18e1b1 -eret=2
void __attribute__((naked,noinline)) sub_fc18e1b0_my() {
    asm volatile (
"    push    {r3, r4, r5, r6, r7, lr}\n"
"    bl      sub_fc0f2242\n"
"    mov     r4, r0\n"
"    movs    r0, #0xc\n"
"    bl      sub_fc309af8\n"
"    ldr     r6, =0x00014c10\n"
"    lsls    r0, r0, #0x1f\n"
"    mov.w   r5, #1\n"
"    bne     loc_fc18e240\n"
"    movs    r2, #2\n"
"    mov     r1, sp\n"
"    movw    r0, #0x115\n"
"    bl      _GetPropertyCase\n" //  PROPCASE_TV (277)
"    lsls    r0, r0, #0x1f\n"
"    beq     loc_fc18e1e4\n"
"    movs    r0, #0\n"
"    movw    r2, #0x1be\n"
"    ldr     r1, =0xfc18e304\n" //  *"SsCaptureCtrl.c"
"    bl      _DebugAssert\n"
"loc_fc18e1e4:\n"
"    ldrsh.w r0, [sp]\n"
"    bl      sub_fc0dbe2a\n"
"    cbz     r0, loc_fc18e1f6\n"
"    str     r5, [r6]\n"
"    bl      sub_fc309b30\n"
"loc_fc18e1f4:\n"
"    pop     {r3, r4, r5, r6, r7, pc}\n"
"loc_fc18e1f6:\n"
"    bl      sub_fc114d80\n"
"    bl      sub_fc0f31a6\n"
"    mov     r0, r4\n"
"    bl      sub_fc0f5f76\n"
"    mov     r1, r4\n"
//"    bl      sub_fc0f5fd2\n"
"bl captseq_raw_addr_init_my\n" // +
"    movs    r2, #4\n"
"    movw    r0, #0x11b\n"
"    add.w   r1, r4, #0x5c\n"
"    bl      _SetPropertyCase\n" //  (283)
"    movs    r2, #4\n"
"    movs    r0, #0x33\n"
"    add.w   r1, r4, #0x60\n"
"    bl      _SetPropertyCase\n" //  (51)
"    movs    r2, #4\n"
"    movs    r0, #0x47\n"
"    add.w   r1, r4, #8\n"
"    bl      _SetPropertyCase\n" //  (71)
"    mov     r0, r4\n"
"    bl      sub_fc18dd1e\n"
"    mov     r0, r4\n"
//"    bl      sub_fc24454a\n"
"    bl      sub_fc24454a_my\n"
"    lsls    r0, r0, #0x1f\n"
"    beq     loc_fc18e1f4\n" //  return
"loc_fc18e240:\n"
"    str     r5, [r6]\n"
"    pop     {r3, r4, r5, r6, r7, pc}\n"
".ltorg\n"
    );
}

// -f=chdk -s=0xfc18e127 -eret
void __attribute__((naked,noinline)) sub_fc18e126_my() {
    asm volatile (
"    push    {r3, r4, r5, r6, r7, lr}\n"
"    ldr     r6, =0x0003e6f8\n"
"    movs    r4, #0\n"
"    mov     r5, r0\n"
"    movw    r0, #0x120\n"
"    ldr     r1, [r6, #0x24]\n"
"    cbz     r1, loc_fc18e186\n"
"    ldr.w   r2, [r5, #0x128]\n"
"    ldr     r1, =0xfc18e31c\n" //  *"  CaptCtrl: Quick(%d)"
"    bl      _LogCameraEvent\n"
"    ldr     r0, =0x00014c10\n"
"    ldr     r0, [r0]\n"
"    cbz     r0, loc_fc18e148\n"
"    movs    r4, #0x1d\n"
"loc_fc18e148:\n"
"    movw    r7, #0x15d\n"
"    movs    r2, #2\n"
"    mov     r1, sp\n"
"    mov     r0, r7\n"
"    bl      _GetPropertyCase\n"
"    lsls    r0, r0, #0x1f\n"
"    beq     loc_fc18e166\n"
"    movs    r0, #0\n"
"    movw    r2, #0x175\n"
"    ldr     r1, =0xfc18e304\n" //  *"SsCaptureCtrl.c"
"    bl      _DebugAssert\n"
"loc_fc18e166:\n"
"    ldr     r0, [r5, #0x1c]\n"
"    movs    r3, #2\n"
"    mov     r2, sp\n"
"    mov     r1, r7\n"
"    bl      sub_fc35b9ac\n"
"    movs    r1, #2\n"
"    mov     r2, r5\n"
"    mov     r0, r4\n"
"    bl      sub_fc0f1134\n"
"    mov     r1, r4\n"
"    mov     r0, r5\n"
"    bl      sub_fc18edc6\n"
"    b       loc_fc18e1aa\n"
"loc_fc18e186:\n"
"    ldr     r1, =0xfc18e338\n" //  *"  CaptCtrl: ExecCapt"
"    bl      _LogCameraEvent\n"
"    mov     r0, r5\n"
//"    bl      sub_fc18df7e\n"
"    bl      sub_fc18df7e_my\n" // -> to hooks
"    mov     r4, r0\n"
"    lsls    r0, r0, #0x1f\n"
"    beq     loc_fc18e1aa\n"
"    movs    r1, #2\n"
"    mov     r2, r5\n"
"    mov     r0, r4\n"
"    bl      sub_fc0f1134\n"
"    mov     r1, r4\n"
"    mov     r0, r5\n"
"    bl      sub_fc18ef28\n"
"loc_fc18e1aa:\n"
"    movs    r0, #0\n"
"    str     r0, [r6, #0x24]\n"
"    pop     {r3, r4, r5, r6, r7, pc}\n"
".ltorg\n"
    );
}

// -f=chdk -s=0xfc18df7f -c=155
void __attribute__((naked,noinline)) sub_fc18df7e_my() {
    asm volatile (
"    push.w  {r2, r3, r4, r5, r6, r7, r8, lr}\n"
"    mov     r4, r0\n"
"    bl      sub_fc0f5f76\n"
"    mov     r1, r4\n"
//"    bl      _captseq_raw_addr_init\n"
"    bl      captseq_raw_addr_init_my\n"
"    movs    r2, #4\n"
"    movw    r0, #0x11b\n"
"    add.w   r1, r4, #0x5c\n"
"    bl      _SetPropertyCase\n" //  (283)
"    movs    r2, #4\n"
"    movs    r0, #0x33\n"
"    add.w   r1, r4, #0x60\n"
"    bl      _SetPropertyCase\n" //  (51)
"    ldr     r5, =0x0003e6f8\n"
"    ldr.w   r0, [r5, #0x108]\n"
"    cbnz    r0, loc_fc18dfc0\n"
"    ldrh.w  r0, [r5, #0x1b6]\n"
"    cmp     r0, #3\n"
"    beq     loc_fc18dfc6\n"
"    ldr     r0, [r4, #8]\n"
"    cmp     r0, #1\n"
"    bhi     loc_fc18dfd6\n"
"    b       loc_fc18dfc6\n"
"loc_fc18dfc0:\n"
"    ldr     r0, [r4, #0xc]\n"
"    cmp     r0, #1\n"
"    bne     loc_fc18dfd6\n"
"loc_fc18dfc6:\n"
"    movs    r0, #0xc\n"
"    bl      sub_fc309af8\n"
"    lsls    r0, r0, #0x1f\n"
"    beq     loc_fc18dfd6\n"
"    bl      sub_fc0f0e4e\n"
"    b       loc_fc18e022\n" //  return 0x1
"loc_fc18dfd6:\n"
"    ldr.w   r0, [r5, #0xec]\n"
"    cbz     r0, loc_fc18dff6\n"
"    ldrh.w  r0, [r5, #0x1b6]\n"
"    cmp     r0, #3\n"
"    beq     loc_fc18dfea\n"
"    ldr     r0, [r4, #8]\n"
"    cmp     r0, #1\n"
"    bhi     loc_fc18e028\n"
"loc_fc18dfea:\n"
"    ldr.w   r0, [r5, #0x108]\n"
"    cbz     r0, loc_fc18dff6\n"
"    ldr     r0, [r4, #0xc]\n"
"    cmp     r0, #1\n"
"    bhi     loc_fc18e028\n"
"loc_fc18dff6:\n"
"    movs    r2, #2\n"
"    movw    r0, #0x115\n"
"    add     r1, sp, #4\n"
"    bl      _GetPropertyCase\n" //  PROPCASE_TV (277)
"    lsls    r0, r0, #0x1f\n"
"    beq     loc_fc18e010\n"
"    movs    r2, #0xcd\n"
"    movs    r0, #0\n"
"    ldr     r1, =0xfc18e304\n" //  *"SsCaptureCtrl.c"
"    bl      _DebugAssert\n"
"loc_fc18e010:\n"
"    ldrsh.w r0, [sp, #4]\n"
"    bl      sub_fc0dbe2a\n"
"    cbz     r0, loc_fc18e028\n"
"    bl      sub_fc0f0e4e\n"
"    bl      sub_fc309b30\n"
"loc_fc18e022:\n"
"    movs    r0, #1\n"
"loc_fc18e024:\n"
"    pop.w   {r2, r3, r4, r5, r6, r7, r8, pc}\n"
"loc_fc18e028:\n"
"    mov     r0, r4\n"
"    bl      sub_fc0f36ca\n"
"    lsls    r1, r0, #0x1f\n"
"    bne     loc_fc18e024\n" //  return
"    ldr     r7, =0x0003e914\n"
"    ldr     r0, [r7]\n"
"    cbz     r0, loc_fc18e04a\n"
"    ldr.w   r0, [r5, #0x19c]\n"
"    cbz     r0, loc_fc18e04a\n"
"    mov     r0, r4\n"
"    bl      sub_fc18eaac\n" //  return
"    mov     r0, r4\n"
"    bl      sub_fc18eaae\n" //  return
"loc_fc18e04a:\n"
"    mov     r0, r4\n"
"    bl      sub_fc18c8d0\n"
"    mov     r6, r0\n"
"    lsls    r0, r0, #0x1f\n"
"    bne     loc_fc18e122\n"
"    ldr     r0, [r7]\n"
"    cbnz    r0, loc_fc18e066\n"
"    ldr.w   r0, [r5, #0x19c]\n"
"    cbz     r0, loc_fc18e066\n"
"    mov     r0, r4\n"
"    bl      sub_fc18eaac\n" //  return
"loc_fc18e066:\n"
"    bl      sub_fc114d80\n"
"    bl      sub_fc0f31a6\n"
"    mov     r0, r4\n"
"    bl      sub_fc18dd1e\n"
"    ldr.w   r0, [r5, #0x12c]\n"
"    cbnz    r0, loc_fc18e088\n"
"    ldrh.w  r0, [r5, #0x1b6]\n"
"    cmp     r0, #3\n"
"    beq     loc_fc18e088\n"
"    ldr     r0, [r4, #8]\n"
"    cmp     r0, #1\n"
"    bhi     loc_fc18e08e\n"
"loc_fc18e088:\n"
"    movs    r0, #2\n"
"    bl      sub_fc0fb412\n"
"loc_fc18e08e:\n"
"    ldr.w   r0, [r5, #0xa0]\n"
"    cmp     r0, #0\n"
"    beq     loc_fc18e100\n"
"    ldrh.w  r0, [r5, #0x1b6]\n"
"    movw    r7, #0x800\n"
"    cmp     r0, #3\n"
"    beq     loc_fc18e0be\n"
"    ldr     r0, [r4, #8]\n"
"    cmp     r0, #1\n"
"    bls     loc_fc18e0be\n"
"    bl      sub_fc18e8be\n"
"    movw    r3, #0x12a\n"
"    movw    r2, #0x3a98\n"
"    mov     r1, r7\n"
"    str     r3, [sp]\n"
"    ldr     r3, =0xfc18e304\n" //  *"SsCaptureCtrl.c"
"    bl      sub_fc309ed0\n"
"loc_fc18e0be:\n"
"    movs    r2, #4\n"
"    movw    r0, #0x18c\n"
"    add     r1, sp, #4\n"
"    bl      _GetPropertyCase\n" //  (396)
"    lsls    r0, r0, #0x1f\n"
"    beq     loc_fc18e0da\n"
"    movs    r0, #0\n"
"    movw    r2, #0x12e\n"
"    ldr     r1, =0xfc18e304\n" //  *"SsCaptureCtrl.c"
"    bl      _DebugAssert\n"
"loc_fc18e0da:\n"
"    ldr     r0, [sp, #4]\n"
"    cbnz    r0, loc_fc18e0ea\n"
"    bl      sub_fc18e8be\n"
"    mov     r1, r7\n"
"    bl      _SetEventFlag\n"
"    b       loc_fc18e100\n"
"loc_fc18e0ea:\n"
"    bl      sub_fc18e8be\n"
"    mov     r1, r7\n"
"    bl      sub_fc369bea\n" // ClearEventFlag
"loc_fc18e0f4:\n"
"    ldr     r2, =0xfc18df6d\n"
"    mov     r3, r7\n"
"    ldr     r0, [sp, #4]\n"
"    mov     r1, r2\n"
"    bl      sub_fc3415ec\n"
"loc_fc18e100:\n"
"    ldr.w   r0, [r5, #0xac]\n"
"    cbz     r0, loc_fc18e10e\n"
"    mov     r0, r4\n"
"    bl      sub_fc244a6c\n"
"    b       loc_fc18e122\n"
"loc_fc18e10e:\n"
"    ldr.w   r0, [r5, #0xb0]\n"
"    cmp     r0, #0\n"
"    mov     r0, r4\n"
"    beq     loc_fc18e11e\n"
"    bl      sub_fc244e0e\n"
"    b       loc_fc18e122\n"
"loc_fc18e11e:\n"
//"    bl      sub_fc24454a\n"
"    bl      sub_fc24454a_my\n" // ->
"loc_fc18e122:\n"
"    mov     r0, r6\n"
"    b       loc_fc18e024\n" //  return
".ltorg\n"
    );
}
#ifdef CAPTSEQ_DEBUG_LOG
void log_nr_call(void) {
    _LogCameraEvent(0x60,"nr hook %d",_nrflag);
}
void log_remote_hook(void) {
    _LogCameraEvent(0x60,"remote hook");
}
void log_rh(void) {
    _LogCameraEvent(0x60,"raw hook rb:0x%08x rbc:0x%08x",hook_raw_image_addr(),current_raw_addr);
}
#endif


// -f=chdk -s=0xfc24454b -eret
void __attribute__((naked,noinline)) sub_fc24454a_my() {
    asm volatile (
"    push.w  {r0, r1, r2, r3, r4, r5, r6, r7, r8, sb, sl, lr}\n"
"    mov     r4, r0\n"
"    bl      sub_fc0f6022\n"
"    ldr     r7, =0x0003e6f8\n"
"    ldr.w   r0, [r7, #0x168]\n"
"    cbz     r0, loc_fc24456a\n"
"    ldrh.w  r0, [r7, #0x1b6]\n"
"    cmp     r0, #3\n"
"    beq     loc_fc24456a\n"
"    ldr     r0, [r4, #8]\n"
"    cmp     r0, #1\n"
"    bhi     loc_fc244574\n"
"loc_fc24456a:\n"
"    mov     r0, r4\n"
"    bl      sub_fc18dc70\n"
"    bl      sub_fc18e788\n"
"loc_fc244574:\n"
"    ldr.w   r0, [r7, #0x9c]\n"
"    cbnz    r0, loc_fc244584\n"
"    movs    r0, #1\n"
"    bl      sub_fc0f36a6\n"
"    bl      sub_fc18e36a\n"
"loc_fc244584:\n"
"    ldr     r0, [r4, #0x1c]\n"
"    movs    r3, #4\n"
"    add     r2, sp, #0xc\n"
"    movw    r1, #0x13c\n"
"    bl      sub_fc35ba28\n"
"    lsls    r0, r0, #0x1f\n"
"    beq     loc_fc2445a2\n"
"    movs    r0, #0\n"
"    movw    r2, #0x1c4\n"
"    ldr     r1, =0xfc24494c\n" //  *"SsStandardCaptureSeq.c"
"    bl      _DebugAssert\n"
"loc_fc2445a2:\n"
"    ldr     r0, [sp, #0xc]\n"
"    ubfx    r0, r0, #8, #8\n"
"    cmp     r0, #6\n"
"    bne     loc_fc2445b2\n"
"    ldr     r0, =0xfc244549\n"
"    movs    r1, #0\n"
"    b       loc_fc2445b6\n"
"loc_fc2445b2:\n"
"    ldr     r0, =0xfc18d8a1\n"
"    mov     r1, r4\n"
"loc_fc2445b6:\n"
"    bl      sub_fc1137d8\n"
"    ldr     r0, [r4, #0x1c]\n"
"    movs    r3, #2\n"
"    add     r2, sp, #8\n"
"    movw    r1, #0x117\n"
"    bl      sub_fc35ba28\n"
"    lsls    r0, r0, #0x1f\n"
"    beq     loc_fc2445d8\n"
"    movs    r0, #0\n"
"    movw    r2, #0x1cd\n"
"    ldr     r1, =0xfc24494c\n" //  *"SsStandardCaptureSeq.c"
"    bl      _DebugAssert\n"
"loc_fc2445d8:\n"
"    ldr.w   r0, [r7, #0x104]\n"
"    cbz     r0, loc_fc24460a\n"
"    ldrh.w  r0, [r7, #0x1b6]\n"
"    cmp     r0, #3\n"
"    beq     loc_fc2445ec\n"
"    ldr     r0, [r4, #8]\n"
"    cmp     r0, #1\n"
"    bhi     loc_fc24460a\n"
"loc_fc2445ec:\n"
"    movs    r0, #1\n"
"    movw    r5, #0x16b\n"
"    movs    r2, #2\n"
"    mov     r1, sp\n"
"    str     r0, [sp]\n"
"    mov     r0, r5\n"
"    bl      _SetPropertyCase\n"
"    ldr     r0, [r4, #0x1c]\n"
"    movs    r3, #2\n"
"    mov     r2, sp\n"
"    mov     r1, r5\n"
"    bl      sub_fc35b9ac\n"
"loc_fc24460a:\n"
// nr hook
"bl capt_seq_hook_set_nr\n"
#ifdef CAPTSEQ_DEBUG_LOG
"bl log_nr_call\n"
#endif
"    mov     r0, r4\n"
"    bl      sub_fc18ddea\n"
"    ldr     r0, [r4, #0x1c]\n"
"    movs    r3, #4\n"
"    movs    r1, #0x93\n"
"    add     r2, sp, #4\n"
"    bl      sub_fc35ba28\n"
"    lsls    r0, r0, #0x1f\n"
"    beq     loc_fc24462c\n"
"    movs    r0, #0\n"
"    movw    r2, #0x1dd\n"
"    ldr     r1, =0xfc24494c\n" //  *"SsStandardCaptureSeq.c"
"    bl      _DebugAssert\n"
"loc_fc24462c:\n"
// later than this point crashes with a HardwareDefect 14
"    BL      wait_until_remote_button_is_released\n" // + remote hook, might be able to go later
#ifdef CAPTSEQ_DEBUG_LOG
"bl log_remote_hook\n"
#endif
"    ldrh    r0, [r4, #0x18]\n"
"    cbnz    r0, loc_fc24463a\n"
"    ldr     r1, [r4, #0x60]\n"
"    mov     r0, r4\n"
"    ldr     r2, [sp, #4]\n"
"    bl      sub_fc18d6b4\n"
"loc_fc24463a:\n"
"    ldr.w   r0, [r7, #0x188]\n"
"    cbz     r0, loc_fc244644\n"
"    bl      sub_fc18db76\n"
"loc_fc244644:\n"
"    bl      sub_fc309f70\n"
"    cbz     r0, loc_fc24464e\n"
"    bl      sub_fc112758\n"
"loc_fc24464e:\n"
"    ldr     r0, =0x0003e914\n"
"    ldr     r0, [r0]\n"
"    cbnz    r0, loc_fc244660\n"
"    ldr.w   r0, [r7, #0x19c]\n"
"    cbz     r0, loc_fc244660\n"
"    mov     r0, r4\n"
"    bl      sub_fc18eaae\n" //  return
"loc_fc244660:\n"
"    ldr     r1, =0x00021c64\n"
"    ldr     r0, [sp, #4]\n"
"    str     r0, [r1]\n"
"    bl      sub_fc0f75da\n"
"    bl      sub_fc18de8e\n"
"    movs    r1, #0\n"
"    mov     r0, r4\n"
"    bl      sub_fc244a0a\n"
"    mov     r6, r0\n"
// this was the remote hook location on sx710, but crashes sx730
"    ldr     r0, [sp, #8]\n"
"    ubfx    r0, r0, #8, #8\n"
"    ldr     r0, [sp, #0xc]\n"
"    ubfx    r0, r0, #8, #8\n"
"    cmp     r0, #6\n"
"    bne     loc_fc244686\n"
"    ldr     r5, =0xfc18db41\n"
"    b       loc_fc244688\n"
"loc_fc244686:\n"
"    ldr     r5, =0xfc18db57\n"
"loc_fc244688:\n"
"    ldrh    r0, [r4, #0x18]\n"
"    cbz     r0, loc_fc2446aa\n"
"    cmp     r0, #1\n"
"    beq     loc_fc2446ba\n"
"    cmp     r0, #4\n"
"    bne     loc_fc24472e\n"
"    str     r6, [sp]\n"
"    mov     r3, r5\n"
"    ldr     r1, [r4, #0x60]\n"
"    mov     r0, r4\n"
"    ldr     r2, [sp, #4]\n"
"    bl      sub_fc18d712\n"
"loc_fc2446a2:\n"
"    mov     r5, r0\n"
"    bl      sub_fc3c9de2\n"
"    b       loc_fc24473c\n"
"loc_fc2446aa:\n"
"    str     r6, [sp]\n"
"    mov     r3, r5\n"
"    ldr     r1, [r4, #0x60]\n"
"    mov     r0, r4\n"
"    ldr     r2, [sp, #4]\n"
"    bl      sub_fc18d5ca\n"
"    b       loc_fc2446a2\n"
"loc_fc2446ba:\n"
"    ldr.w   r0, [r7, #0xc4]\n"
"    cbz     r0, loc_fc2446cc\n"
"    movs    r0, #0\n"
"    movw    r2, #0x221\n"
"    ldr     r1, =0xfc24494c\n" //  *"SsStandardCaptureSeq.c"
"    bl      _DebugAssert\n"
"loc_fc2446cc:\n"
"    str     r6, [sp]\n"
"    mov     r3, r5\n"
"    ldr     r1, [r4, #0x60]\n"
"    mov     r0, r4\n"
"    ldr     r2, [sp, #4]\n"
"    bl      sub_fc18d73e\n"
"    movs    r2, #1\n"
"    mov     r5, r0\n"
"    movs    r1, #0\n"
"    movs    r0, #0x45\n"
"    bl      sub_fc280646\n"
"    lsls    r0, r5, #0x1f\n"
"    bne     loc_fc24473c\n"
"    ldr.w   r0, [r7, #0xfc]\n"
"    cbz     r0, loc_fc244700\n"
"    ldr     r1, [r4, #8]\n"
"    ldr     r2, =0x001dbfb8\n"
"    ldr     r0, [r4, #0x60]\n"
"    add.w   r1, r2, r1, lsl #2\n"
"    str     r0, [r1, #-0x4]\n"
"    b       loc_fc244726\n"
"loc_fc244700:\n"
"    ldr     r0, =0xfc244549\n"
"    movs    r1, #0\n"
"    bl      sub_fc1137d8\n"
"    movs    r1, #1\n"
"    mov     r0, r4\n"
"    bl      sub_fc244a0a\n"
"    mov     r6, r0\n"
"    ldr     r0, [sp, #4]\n"
"    bl      sub_fc18dbd2\n"
"    ldr     r1, [r4, #0x60]\n"
"    mov     r3, r6\n"
"    ldr     r2, [sp, #4]\n"
"    mov     r0, r4\n"
"    bl      sub_fc18d7b2\n"
"    mov     r5, r0\n"
"loc_fc244726:\n"
"    movs    r0, #0\n"
"    bl      sub_fc18d5a8\n"
"    b       loc_fc24473c\n"
"loc_fc24472e:\n"
"    movs    r0, #0\n"
"    movw    r2, #0x24b\n"
"    ldr     r1, =0xfc24494c\n" //  *"SsStandardCaptureSeq.c"
"    bl      _DebugAssert\n"
"    movs    r5, #0x1d\n"
"loc_fc24473c:\n"
"    bl      sub_fc18de92\n"
"    ldr.w   r8, =0xfc244549\n"
"    lsls    r0, r5, #0x1f\n"
"    bne     loc_fc244798\n"
"    ldr.w   r0, [r7, #0x104]\n"
"    cbnz    r0, loc_fc244764\n"
"    mov     r0, r4\n"
"    bl      sub_fc18f320\n"
"    lsls    r0, r0, #0x1f\n"
"    beq     loc_fc244764\n"
"    movs    r0, #0\n"
"    movw    r2, #0x268\n"
"    ldr     r1, =0xfc24494c\n" //  *"SsStandardCaptureSeq.c"
"    bl      _DebugAssert\n"
"loc_fc244764:\n"
// raw hook
#ifdef CAPTSEQ_DEBUG_LOG
"bl log_rh\n"
#endif
"    BL      capt_seq_hook_raw_here\n"
"    BL      clear_current_raw_addr\n"
"    mov     r0, r4\n"
"    bl      sub_fc18de7e\n"
"    mov     r0, r4\n"
"    bl      sub_fc18de52\n"
"    cmp     r6, r8\n"
"    beq     loc_fc244798\n"
"    bl      sub_fc18e8be\n"
"    movs    r1, #4\n"
"    movw    sb, #0x275\n"
"    ldr     r3, =0xfc24494c\n" //  *"SsStandardCaptureSeq.c"
"    movw    r2, #0x3a98\n"
"    str.w   sb, [sp]\n"
"    bl      sub_fc309ed0\n"
"    cbz     r0, loc_fc244798\n"
"    movs    r0, #0\n"
"    mov     r2, sb\n"
"    ldr     r1, =0xfc24494c\n" //  *"SsStandardCaptureSeq.c"
"    bl      _DebugAssert\n"
"loc_fc244798:\n"
"    ldr.w   r0, [r7, #0x188]\n"
"    cbz     r0, loc_fc2447a8\n"
"    movs    r2, #1\n"
"    movs    r1, #0\n"
"    movs    r0, #0x46\n"
"    bl      sub_fc280646\n"
"loc_fc2447a8:\n"
"    movs    r1, #2\n"
"    mov     r2, r4\n"
"    mov     r0, r5\n"
"    bl      sub_fc0f1134\n"
"    ldr     r0, [r7, #0x24]\n"
"    cmp     r0, #0\n"
"    mov     r0, r8\n"
"    beq     loc_fc2447ce\n"
"    cmp     r6, r0\n"
"    beq     loc_fc2447c2\n"
"    movs    r1, #1\n"
"    b       loc_fc2447c4\n"
"loc_fc2447c2:\n"
"    movs    r1, #0\n"
"loc_fc2447c4:\n"
"    mov     r2, r5\n"
"    mov     r0, r4\n"
"    bl      sub_fc18ed84\n"
"    b       loc_fc2447e0\n"
"loc_fc2447ce:\n"
"    cmp     r6, r0\n"
"    beq     loc_fc2447d6\n"
"    movs    r1, #1\n"
"    b       loc_fc2447d8\n"
"loc_fc2447d6:\n"
"    movs    r1, #0\n"
"loc_fc2447d8:\n"
"    mov     r2, r5\n"
"    mov     r0, r4\n"
"    bl      sub_fc18ed3e\n"
"loc_fc2447e0:\n"
"    add     sp, #0x10\n"
"    mov     r0, r5\n"
"    pop.w   {r4, r5, r6, r7, r8, sb, sl, pc}\n"
".ltorg\n"
    );
}
