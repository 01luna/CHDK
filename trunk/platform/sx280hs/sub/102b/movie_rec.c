
// byte offset of bitrate constants inside the fw struct passed to set_quality()
#define BR_LOW_OFS 0x2c
#define BR_MID_OFS 0x30
#define BR_HI_OFS  0x28

// maximum allowed bitrate that doesn't crash the camera
#define MAX_VIDEO_BITRATE 35040

#define FW_SHORT_TIME_LIMIT 30      // unlocking fw time limits below this require user permission (seconds)
#define SHORT_TIME_LIMIT 300        // raised time limit for movie modes that have more restricted fw time limits
#define LONG_TIME_LIMIT (3*60*60)   // raised time limit for all other movie kinds

#include "../../../generic/movie_rec.c"

void __attribute__((naked,noinline)) movie_record_task() {
    asm volatile (
// capdis -f=chdk -s=task_MovieRecord -c=85 -stubs PRIMARY.BIN 0xfc000000
// task_MovieRecord 0xfc1a5d09
"    push.w  {r2, r3, r4, r5, r6, r7, r8, lr}\n"
"    ldr     r5, =0x00010b08\n"
"    movs    r6, #0\n"
"    movw    r7, #0xaea\n"
"    movw    r8, #0x2710\n"
"    sub.w   r4, r5, #0x80\n"
"loc_fc1a5d1c:\n"
"    movs    r2, #0\n"
"    add     r1, sp, #4\n"
"    ldr     r0, [r4, #0xc]\n"
"    blx     sub_fc251bfc\n" // j_ReceiveMessageQueue
"    ldr     r0, [sp, #4]\n"
"    ldr     r0, [r0]\n"
"    cmp     r0, #6\n"
"    bhs     loc_fc1a5dd0\n"
"    tbb     [pc, r0]\n" // (jumptable r0 6 elements)
"branchtable_fc1a5d32:\n"
"    .byte((loc_fc1a5d38 - branchtable_fc1a5d32) / 2)\n" // (case 0)
"    .byte((loc_fc1a5d56 - branchtable_fc1a5d32) / 2)\n" // (case 1)
"    .byte((loc_fc1a5d78 - branchtable_fc1a5d32) / 2)\n" // (case 2)
"    .byte((loc_fc1a5d7e - branchtable_fc1a5d32) / 2)\n" // (case 3)
"    .byte((loc_fc1a5d9e - branchtable_fc1a5d32) / 2)\n" // (case 4)
"    .byte((loc_fc1a5db0 - branchtable_fc1a5d32) / 2)\n" // (case 5)
".align 1\n"
"loc_fc1a5d38:\n"
"    bl      replace_apendstrm\n"   // +
"    ldr     r0, [r5, #0x1c]\n"
"    cbz     r0, loc_fc1a5d42\n"
"loc_fc1a5d3c:\n"
"    bl      sub_fc1a4618\n"
"    b       loc_fc1a5dd0\n"
"loc_fc1a5d42:\n"
"    ldr     r0, [r4, #0x5c]\n"
"    cbnz    r0, loc_fc1a5d4a\n"
"    bl      sub_fc1a63b4\n"
"loc_fc1a5d4a:\n"
"    bl      sub_fc1a5b6e_my\n"     // ->
"loc_fc1a5d4e:\n"
"    cmp     r0, #0\n"
"    str     r0, [r5, #0x1c]\n"
"    bne     loc_fc1a5d3c\n"
"    b       loc_fc1a5dd0\n"
"loc_fc1a5d56:\n"
"    bl      sub_fc1a5996\n"
"    str     r0, [r5, #0x1c]\n"
"    ldr     r1, [r4, #0x5c]\n"
"    cbnz    r1, loc_fc1a5d6e\n"
"    lsls    r0, r0, #0x1f\n"
"    bne     loc_fc1a5d6a\n"
"    bl      sub_fc1a57e8\n"
"    str     r0, [r5, #0x1c]\n"
"loc_fc1a5d6a:\n"
"    bl      sub_fc1a63d2\n"
"loc_fc1a5d6e:\n"
"    ldr     r0, [r5, #0x1c]\n"
"    b       loc_fc1a5d98\n"
"loc_fc1a5d72:\n"
"    ldr     r1, [r5, #0x30]\n"
"    ldr     r0, [r5, #0x44]\n"
"    b       loc_fc1a5dac\n"
"loc_fc1a5d78:\n"
"    bl      sub_fc1a65fe\n"
"    b       loc_fc1a5d4e\n"
"loc_fc1a5d7e:\n"
"    bl      sub_fc1a63b4\n"
"    bl      sub_fc1a562e\n"
"    cmp     r0, #0\n"
"    str     r0, [r5, #0x1c]\n"
"    bne     loc_fc1a5d3c\n"
"    ldr     r0, [r4, #0x6c]\n"
"    cmp     r0, #0\n"
"    beq     loc_fc1a5d72\n"
"    bl      sub_fc1a54cc\n"
"    str     r0, [r5, #0x1c]\n"
"loc_fc1a5d98:\n"
"    cmp     r0, #0\n"
"    beq     loc_fc1a5d72\n"
"    b       loc_fc1a5d3c\n"
"loc_fc1a5d9e:\n"
"    bl      sub_fc1a54cc\n"
"    cmp     r0, #0\n"
"    str     r0, [r5, #0x1c]\n"
"    bne     loc_fc1a5d3c\n"
"    ldr     r1, [r5, #0x38]\n"
"    ldr     r0, [r5, #0x4c]\n"
"loc_fc1a5dac:\n"
"    blx     r1\n"
"    b       loc_fc1a5dd0\n"
"loc_fc1a5db0:\n"
"    bl      sub_fc1a5eea\n"
"    lsls    r0, r0, #0x1f\n"
"    beq     loc_fc1a5dbc\n"
"    movs    r0, #1\n"
"    b       loc_fc1a5dc4\n"
"loc_fc1a5dbc:\n"
"    str     r6, [r4, #0x34]\n"
"    mov     r0, r6\n"
"    str     r6, [r4, #0x5c]\n"
"    str     r6, [r4, #0x58]\n"
"loc_fc1a5dc4:\n"
"    str     r0, [r5, #0x1c]\n"
"    cbz     r0, loc_fc1a5dd0\n"
"    mov.w   r0, #0xa0000\n"
"    bl      sub_fc07b032\n" // HardwareDefect_FW
"loc_fc1a5dd0:\n"
"    ldr     r1, [sp, #4]\n"
"    mov     r2, r8\n"
"    ldr     r3, =0xfc1a4a18\n" //  **"MovieRecorder.c"
"    str     r6, [r1]\n"
"    str     r7, [sp]\n"
"    ldr     r0, [r4, #0x14]\n"
"    blx     sub_fc251afc\n" // j_PostMessageQueueStrictly
"    b       loc_fc1a5d1c\n"
".ltorg\n"
    );
}

void __attribute__((naked,noinline)) sub_fc1a5b6e_my() {
    asm volatile (
// capdis -f=chdk -s=0xFC1A5B6f -c=13 -stubs PRIMARY.BIN 0xfc000000
"    push.w  {r4, r5, r6, r7, r8, lr}\n"
"    ldr     r5, =0x00010a88\n"
"    sub     sp, #0xf0\n"
"    add     r1, sp, #0x18\n"
"    add     r0, sp, #0x84\n"
"    mov     r4, r1\n"
"    ldr     r2, [r5, #0x5c]\n"
"    bl      sub_fc1a484e\n"
"    add     r0, sp, #0x84\n"
"    bl      sub_fc23e51c\n"
"    add     r0, sp, #4\n"
"    mov     r1, r4\n"
"    bl      sub_fc1a499c_my\n"     // ->
"    ldr     pc, =0xFC1A5B91\n"     // + back to rom
".ltorg\n"
    );
}

void __attribute__((naked,noinline)) sub_fc1a499c_my() {
    asm volatile (
// capdis -f=chdk -s=0xFC1A499d -c=495 -stubs PRIMARY.BIN 0xfc000000
"    push.w  {r0, r1, r2, r3, r4, r5, r6, r7, r8, sb, sl, fp, ip, lr}\n"
"    movs    r6, #0\n"
"    ldr.w   r8, =0x00010a88\n"
"    mov.w   fp, #1\n"
"    mov     r5, r0\n"
"    add.w   r8, r8, #0x80\n"
"    mov     r4, r1\n"
"    strd    fp, r6, [sp]\n"
"    strb.w  fp, [r0]\n"
"    mov     sl, r6\n"
"    strb    r6, [r0, #1]\n"
"    ldr.w   r0, [r8, #0x20]\n"
"    bl      sub_fc2a4636\n" // GetDrive_ClusterSize
"    ldr     r7, =0x00010a88\n"
"    str     r0, [r7, #0x40]\n"
"    str     r0, [r5, #8]\n"
"    strb.w  sl, [r5, #4]\n"
"    ldr.w   r0, [r8, #0x20]\n"
"    bl      sub_fc2a4d98\n"
"    cbz     r0, loc_fc1a4a08\n"
"    ldr.w   r0, [r8, #0x20]\n"
"    bl      sub_fc2a45d0\n" // get_fstype
"    cmp     r0, #4\n"
"    bne     loc_fc1a49ea\n"
"    mov     r0, fp\n"
"    b       loc_fc1a49ec\n"
"loc_fc1a49ea:\n"
"    mov     r0, sl\n"
"loc_fc1a49ec:\n"
"    strb    r0, [r7]\n"
"    uxtb    r0, r0\n"
"    mov     sb, r7\n"
"    cmp     r0, #2\n"
"    strb    r0, [r5, #6]\n"
"    beq     loc_fc1a4ab4\n"
"    add.w   r2, r5, #0x10\n"
"    ldr.w   r0, [r8, #0x20]\n"
"    subs    r1, r2, #4\n"
"    bl      sub_fc2a4cbe\n"
"    b       loc_fc1a4abc\n"
"loc_fc1a4a08:\n"
//"    b       loc_fc1a4ab0\n"
// literal pool removed
//"loc_fc1a4ab0:\n"
"    movs    r0, #2\n"
"    b       loc_fc1a49ec\n"
"loc_fc1a4ab4:\n"
"    ldr.w   r0, [sb, #0x40]\n"
"    str     r0, [r5, #0xc]\n"
"    str     r0, [r5, #0x10]\n"
"loc_fc1a4abc:\n"
"    add.w   r4, r4, #0x1c\n"
"    movs    r0, #0x64\n"
"    movw    r1, #0xbb80\n"
"    mov     r7, fp\n"
"    strb    r0, [r4, #3]\n"
"    strb.w  sl, [r4, #8]\n"
"    strb.w  sl, [r4, #6]\n"
"    strb.w  fp, [r4, #9]\n"
"    strb.w  fp, [r4, #0xb]\n"
"    str     sl, [r4, #-0x10]\n"
"    strb.w  sl, [r4, #5]\n"
"    strb.w  fp, [r4, #7]\n"
"    strb.w  fp, [r4, #0x1c]\n"
"    str     r1, [r4, #0x30]\n"
"    mov.w   r1, #0x10\n"
"    strh    r1, [r4, #0x34]\n"
"    mov.w   r1, #0x1f400\n"
"    str     r1, [r4, #0x3c]\n"
"    mov.w   r1, #0x300000\n"
"    strb.w  sl, [r4, #0x38]\n"
"    sub.w   r4, r4, #0x1c\n"
"    ldr.w   r0, [sb, #0x40]\n"
"    cmp     r0, r1\n"
"    bls     loc_fc1a4b10\n"
"    str     r0, [r4, #0x14]\n"
"    b       loc_fc1a4b12\n"
".ltorg\n"                      // +
"loc_fc1a4b10:\n"
"    str     r1, [r4, #0x14]\n"
"loc_fc1a4b12:\n"
"    movs    r2, #0xf\n"
"    ldr.w   r3, [r8, #0x60]\n"
"    movw    r0, #0x3e9\n"
"    ldr.w   lr, =0x0001003c\n"
"    movw    r1, #0xbb5\n"
"    cmp     r3, #0xc\n"
"    movw    ip, #0x7530\n"
"    mov.w   fp, #3\n"
"    bhs     loc_fc1a4bf8\n"
"    tbb     [pc, r3]\n" // (jumptable r3 12 elements)
"branchtable_fc1a4b34:\n"
"    .byte((loc_fc1a4b92 - branchtable_fc1a4b34) / 2)\n" // (case 0)
"    .byte((loc_fc1a4bf8 - branchtable_fc1a4b34) / 2)\n" // (case 1)
"    .byte((loc_fc1a4bf8 - branchtable_fc1a4b34) / 2)\n" // (case 2)
"    .byte((loc_fc1a4b76 - branchtable_fc1a4b34) / 2)\n" // (case 3)
"    .byte((loc_fc1a4b66 - branchtable_fc1a4b34) / 2)\n" // (case 4)
"    .byte((loc_fc1a4b40 - branchtable_fc1a4b34) / 2)\n" // (case 5)
"    .byte((loc_fc1a4bf8 - branchtable_fc1a4b34) / 2)\n" // (case 6)
"    .byte((loc_fc1a4bf8 - branchtable_fc1a4b34) / 2)\n" // (case 7)
"    .byte((loc_fc1a4bf8 - branchtable_fc1a4b34) / 2)\n" // (case 8)
"    .byte((loc_fc1a4ba4 - branchtable_fc1a4b34) / 2)\n" // (case 9)
"    .byte((loc_fc1a4bb4 - branchtable_fc1a4b34) / 2)\n" // (case 10)
"    .byte((loc_fc1a4bd6 - branchtable_fc1a4b34) / 2)\n" // (case 11)
".align 1\n"
"loc_fc1a4b40:\n"
"    movw    r1, #0x176a\n"
"    strh    r1, [r4, #0x1c]\n"
"    movs    r1, #0x1e\n"
"    strb    r1, [r4, #1]\n"
"    str.w   lr, [r4, #0x34]\n"
"    movw    r3, #0xea60\n"
"    strb.w  r7, [r4, #0x22]\n"
"    strb    r1, [r5, #5]\n"
"    strd    r3, r0, [r8, #8]\n"
"    strd    r0, r3, [sp]\n"
"    strh.w  r1, [sb, #2]\n"
"    b       loc_fc1a4c06\n"
"loc_fc1a4b66:\n"
"    strh    r1, [r4, #0x1c]\n"
"    ldr     r1, =0x0001003c\n"
"    strb    r2, [r4, #1]\n"
"    adds    r1, #0x3c\n"
"    str     r1, [r4, #0x34]\n"
"    ldr     r1, =0x0001d4c0\n"
"    strb    r2, [r5, #5]\n"
"    b       loc_fc1a4b84\n"
"loc_fc1a4b76:\n"
"    strh    r1, [r4, #0x1c]\n"
"    ldr     r1, =0x0001003c\n"
"    strb    r2, [r4, #1]\n"
"    adds    r1, #0xb4\n"
"    str     r1, [r4, #0x34]\n"
"    ldr     r1, =0x0003a980\n"
"    strb    r2, [r5, #5]\n"
"loc_fc1a4b84:\n"
"    strd    r1, r0, [r8, #8]\n"
"loc_fc1a4b88:\n"
"    strd    r0, ip, [sp]\n"
"    mov     r0, sb\n"
"loc_fc1a4b8e:\n"
"    strh    r2, [r0, #2]\n"
"    b       loc_fc1a4c06\n"
"loc_fc1a4b92:\n"
"    strh    r1, [r4, #0x1c]\n"
"    ldr     r1, =0x0001003c\n"
"    strb    r2, [r4, #1]\n"
"    subs    r1, #0x1e\n"
"    str     r1, [r4, #0x34]\n"
"    strb    r2, [r5, #5]\n"
"    strd    ip, r0, [r8, #8]\n"
"    b       loc_fc1a4b88\n"
"loc_fc1a4ba4:\n"
"    strh    r1, [r4, #0x1c]\n"
"    movw    r1, #0x1770\n"
"    strb    r2, [r4, #1]\n"
"    str.w   lr, [r4, #0x34]\n"
"    strb    r2, [r5, #5]\n"
"    b       loc_fc1a4b84\n"
"loc_fc1a4bb4:\n"
"    strh    r1, [r4, #0x1c]\n"
"    movw    r1, #0xbb8\n"
"    strb    r2, [r4, #1]\n"
"    str.w   lr, [r4, #0x34]\n"
"    strb    r2, [r5, #5]\n"
"    strd    r1, r0, [r8, #8]\n"
"    strd    r0, ip, [sp]\n"
"    str.w   r7, [sb, #0x78]\n"
"    mov     r0, sb\n"
"    str.w   r7, [sb, #0x7c]\n"
"    b       loc_fc1a4b8e\n"
"loc_fc1a4bd6:\n"
"    strh    r1, [r4, #0x1c]\n"
"    movw    r1, #0x5dc\n"
"    strb    r2, [r4, #1]\n"
"    str.w   lr, [r4, #0x34]\n"
"    strb    r2, [r5, #5]\n"
"    strd    r1, r0, [r8, #8]\n"
"    strd    r0, ip, [sp]\n"
"    str.w   fp, [sb, #0x78]\n"
"    mov     r0, sb\n"
"    str.w   fp, [sb, #0x7c]\n"
"    b       loc_fc1a4b8e\n"
"loc_fc1a4bf8:\n"
"    movw    r2, #0x3b9\n"
"    ldr     r1, =0xfc1a4a18\n" //  *"MovieRecorder.c"
"    movs    r0, #0\n"
"    blx     sub_fc251d14\n" // j_DebugAssert
"loc_fc1a4c06:\n"
"    movs    r0, #2\n"
"    strb    r0, [r4]\n"
"    strb.w  sl, [r4, #0x26]\n"
"    mov     r1, sl\n"
"    ldr.w   r0, [sb, #0x58]\n"     // all-i flag
"    cbz     r0, loc_fc1a4c2e\n"
"    strb    r1, [r4]\n"
"    strb    r7, [r4, #1]\n"
"    strb.w  r7, [r4, #0x26]\n"
"    strb.w  r7, [r4, #0x22]\n"
"    ldr     r2, =0x00010ba0\n"
"    strh.w  r7, [sb, #2]\n"
"    str.w   r2, [r8, #0x10]\n"
"    b       loc_fc1a4c32\n"
"loc_fc1a4c2e:\n"
"    str.w   r1, [r8, #0x10]\n"
"loc_fc1a4c32:\n"
"    movs    r1, #0\n"
"    ldr     r2, =0x001a0800\n"
"    movs    r3, #6\n"
"    movw    ip, #0x140\n"
"    movw    lr, #0xffff\n"
"    strd    r2, r1, [r4, #0x3c]\n"
"    lsls    r1, r2, #0x10\n"
"    str     r1, [r4, #0x44]\n"
"    movs    r2, #5\n"
"    movw    sl, #0xe0f\n"              // time limit
"    asrs    r1, r1, #0x10\n"
"    str     r1, [r4, #0x48]\n"
"    ldr.w   r1, [r8, #0x58]\n"
"    cmp     r1, ip\n"
"    beq     loc_fc1a4d50\n"
"    movw    ip, #0x280\n"
"    cmp     r1, ip\n"
"    beq     loc_fc1a4d1e\n"
"    lsls    r3, r2, #8\n"
"    mov.w   ip, #0x29\n"
"    cmp     r1, r3\n"
"    movw    r2, #0x707\n"              // time limit
"    beq     loc_fc1a4ccc\n"
"    movw    r0, #0x780\n"
"    cmp     r1, r0\n"
"    bne     loc_fc1a4d52\n"
"    strh    r0, [r4, #4]\n"
"    movw    r1, #0x438\n"
"    strh    r1, [r4, #2]\n"
"    strh    r0, [r4, #8]\n"
"    strh    r1, [r4, #6]\n"
"    strb.w  r7, [r4, #0x20]\n"
"    strb.w  r7, [r4, #0x39]\n"
"    strb.w  r7, [r4, #0x3a]\n"
"    strb.w  r7, [r4, #0x3b]\n"
"    strh.w  r7, [sb, #6]\n"
"    ldr.w   r0, [r8, #0x60]\n"
"    cmp     r0, #5\n"
"    bne     loc_fc1a4cb6\n"
"    movw    r0, #0x88b8\n"
"    str     r0, [r4, #0x28]\n"
"    movw    r0, #0x8854\n"
"    str     r0, [r4, #0x30]\n"
"    movw    r0, #0x87f0\n"
"    str     r0, [r4, #0x2c]\n"
"    movs    r0, #0x2a\n"
"    b       loc_fc1a4d1a\n"
"loc_fc1a4cb6:\n"
"    movw    r0, #0x5dc0\n"
"    str     r0, [r4, #0x28]\n"
"    movw    r0, #0x5d5c\n"
"    str     r0, [r4, #0x30]\n"
"    movw    r0, #0x5cf8\n"
"    b       loc_fc1a4cfe\n"
"loc_fc1a4cc8:\n"
"    mov     r6, r2\n"
"    b       loc_fc1a4de6\n"
"loc_fc1a4ccc:\n"
"    strh    r3, [r4, #4]\n"
"    movw    r1, #0x2d0\n"
"    strh    r1, [r4, #2]\n"
"    strh    r3, [r4, #8]\n"
"    strh    r1, [r4, #6]\n"
"    strb.w  r7, [r4, #0x20]\n"
"    strb.w  r7, [r4, #0x39]\n"
"    strb.w  r7, [r4, #0x3a]\n"
"    strb.w  r7, [r4, #0x3b]\n"
"    strh.w  r7, [sb, #6]\n"
"    cbz     r0, loc_fc1a4d06\n"
"    movw    r0, #0x9c40\n"
"    str     r0, [r4, #0x28]\n"
"    movw    r0, #0x9bdc\n"
"    str     r0, [r4, #0x30]\n"
"    movw    r0, #0x9b78\n"
"loc_fc1a4cfe:\n"
"    str     r0, [r4, #0x2c]\n"
"    strb.w  ip, [r4, #0x1e]\n"
"    b       loc_fc1a4cc8\n"
"loc_fc1a4d06:\n"
"    movw    r0, #0x1f40\n"
"    str     r0, [r4, #0x28]\n"
"    movw    r0, #0x1edc\n"
"    str     r0, [r4, #0x30]\n"
"    movw    r0, #0x1e78\n"
"    str     r0, [r4, #0x2c]\n"
"    movs    r0, #0x1f\n"
"loc_fc1a4d1a:\n"
"    strb    r0, [r4, #0x1e]\n"
"    b       loc_fc1a4cc8\n"
"loc_fc1a4d1e:\n"
"    strh.w  ip, [r4, #4]\n"
"    movw    r0, #0x1e0\n"
"    strh    r0, [r4, #2]\n"
"    strh.w  ip, [r4, #8]\n"
"    strh    r0, [r4, #6]\n"
"    add.w   r4, r4, #0x20\n"
"    ldr.w   r0, [r8, #0x60]\n"
"    cmp     r0, #1\n"
"    beq     loc_fc1a4d54\n"
"    strb    r3, [r4]\n"
"    strb.w  fp, [r4, #0x19]\n"
"    strb    r7, [r4, #0x1a]\n"
"    strb.w  fp, [r4, #0x1b]\n"
"    sub.w   r4, r4, #0x20\n"
"    strh.w  r3, [sb, #6]\n"
"    b       loc_fc1a4d66\n"
"loc_fc1a4d50:\n"
"    b       loc_fc1a4d7c\n"
"loc_fc1a4d52:\n"
"    b       loc_fc1a4dd8\n"
"loc_fc1a4d54:\n"
"    strb    r2, [r4]\n"
"    movs    r0, #2\n"
"    strb    r0, [r4, #0x19]\n"
"    strb    r7, [r4, #0x1a]\n"
"    strb    r0, [r4, #0x1b]\n"
"    sub.w   r4, r4, #0x20\n"
"    strh.w  lr, [sb, #6]\n"
"loc_fc1a4d66:\n"
"    movw    r0, #0xbb8\n"
"    str     r0, [r4, #0x28]\n"
"    movw    r0, #0xb54\n"
"    str     r0, [r4, #0x30]\n"
"    movw    r0, #0xaf0\n"
"    str     r0, [r4, #0x2c]\n"
"    movs    r0, #0x1e\n"
"    b       loc_fc1a4dd2\n"
"loc_fc1a4d7c:\n"
"    strh.w  ip, [r4, #4]\n"
"    movs    r0, #0xf0\n"
"    strh    r0, [r4, #2]\n"
"    strh.w  ip, [r4, #8]\n"
"    strh    r0, [r4, #6]\n"
"    add.w   r4, r4, #0x20\n"
"    ldr.w   r0, [r8, #0x60]\n"
"    cmp     r0, #1\n"
"    beq     loc_fc1a4dac\n"
"    strb    r3, [r4]\n"
"    strb.w  fp, [r4, #0x19]\n"
"    strb    r7, [r4, #0x1a]\n"
"    strb.w  fp, [r4, #0x1b]\n"
"    sub.w   r4, r4, #0x20\n"
"    strh.w  r3, [sb, #6]\n"
"    b       loc_fc1a4dbe\n"
"loc_fc1a4dac:\n"
"    strb    r2, [r4]\n"
"    movs    r0, #2\n"
"    strb    r0, [r4, #0x19]\n"
"    strb    r7, [r4, #0x1a]\n"
"    strb    r0, [r4, #0x1b]\n"
"    sub.w   r4, r4, #0x20\n"
"    strh.w  lr, [sb, #6]\n"
"loc_fc1a4dbe:\n"
"    movw    r0, #0x3e8\n"
"    str     r0, [r4, #0x28]\n"
"    movw    r0, #0x384\n"
"    str     r0, [r4, #0x30]\n"
"    movw    r0, #0x320\n"
"    str     r0, [r4, #0x2c]\n"
"    movs    r0, #0x14\n"
"loc_fc1a4dd2:\n"
"    mov     r6, sl\n"
"    strb    r0, [r4, #0x1e]\n"
"    b       loc_fc1a4de6\n"
"loc_fc1a4dd8:\n"
"    movw    r2, #0x443\n"
"    ldr     r1, =0xfc1a4a18\n" //  *"MovieRecorder.c"
"    movs    r0, #0\n"
"    blx     sub_fc251d14\n" // j_DebugAssert
"loc_fc1a4de6:\n"
"    ldr.w   r0, [r8, #0x60]\n"
"    cmp     r0, #4\n"
"    beq     loc_fc1a4df2\n"
"    cmp     r0, #3\n"
"    bne     loc_fc1a4df8\n"
"loc_fc1a4df2:\n"
"    movs    r6, #0x1e\n"               // time limit, 30s for slo-mo
"    str.w   r7, [sb, #0x60]\n"
"loc_fc1a4df8:\n"

// movie time limit modification, r0...r3 does not seem to carry anything useful here, so they are not backed up
"    mov     r0, r6\n"                  // + original limit is in r6
"    bl      set_movie_time_limit\n"    // +
"    mov     r6, r0\n"                  // +
// bitrate mod
"    mov     r0, r4\n"                  // + addr of struct with bitrates is in r4
"    bl      set_quality\n"             // +

"    ldr     r1, =0x00010ba0\n"
"    mov.w   r8, #0\n"
"    subs    r1, #0x98\n"
"    ldr     r0, [r1, #8]\n"
"    str     r0, [sp, #0xc]\n"
"    mul     r2, r6, r0\n"
"    ldr     r0, [r1, #0xc]\n"
"    mov     sl, r0\n"
"    udiv    r0, r2, r0\n"
"    mvn     r2, #9\n"
"    str     r0, [r1, #0x6c]\n"
"    str     r0, [sp, #8]\n"
"    adds    r0, r6, r2\n"
"    str.w   r0, [sb, #0x50]\n"
"    adc     r1, r8, #-1\n"
"    ldr.w   r0, [sb, #0x74]\n"
"    mov     r1, sb\n"
"    cbnz    r0, loc_fc1a4e36\n"
"    ldr     r0, [sp, #0xc]\n"
"    add     r0, sl\n"
"    subs    r0, r0, #1\n"
"    udiv    r0, r0, sl\n"
"    str     r0, [r1, #0x74]\n"
"loc_fc1a4e36:\n"
"    ldr     r0, [r1, #0x5c]\n"
"    cbz     r0, loc_fc1a4e4c\n"
"    strb    r7, [r5, #2]\n"
"    movs    r0, #8\n"
"    strb.w  r8, [r5, #7]\n"
"    str     r0, [r4, #0x10]\n"
"    movw    r0, #0x780\n"
"    str     r0, [r4, #0x18]\n"
"    b       loc_fc1a4e72\n"
"loc_fc1a4e4c:\n"
"    strb.w  r8, [r5, #2]\n"
"    ldrb    r0, [r5, #6]\n"
"    cmp     r0, #2\n"
"    beq     loc_fc1a4e5a\n"
"    strb    r7, [r5, #7]\n"
"    b       loc_fc1a4e5e\n"
"loc_fc1a4e5a:\n"
"    strb.w  r8, [r5, #7]\n"
"loc_fc1a4e5e:\n"
"    ldrh    r0, [r1, #2]\n"
"    ldr     r2, [sp, #8]\n"
"    str.w   r8, [r4, #0x18]\n"
"    add     r2, r0\n"
"    subs    r2, r2, #1\n"
"    udiv    r0, r2, r0\n"
"    adds    r0, r0, #1\n"
"    str     r0, [r4, #0x10]\n"
"loc_fc1a4e72:\n"
"    movs    r0, #2\n"
"    strh.w  r0, [r4, #0x52]\n"
"    strh    r0, [r1, #4]\n"
"    mov     r6, r1\n"
"    ldr     r0, [r1, #0x64]\n"
"    cbz     r0, loc_fc1a4e84\n"
"    strb    r7, [r5, #3]\n"
"    b       loc_fc1a4e88\n"
"loc_fc1a4e84:\n"
"    strb.w  r8, [r5, #3]\n"
"loc_fc1a4e88:\n"
"    movs    r3, #2\n"
"    ldr     r5, =0x00010ba0\n"
"    movs    r1, #0xa9\n"
"    add     r2, sp, #4\n"
"    subs    r5, #0x98\n"
"    ldr     r0, [r5, #0x24]\n"
"    bl      sub_fc297b4a\n"
"    ldr     r0, [r5, #0x24]\n"
"    movs    r3, #2\n"
"    movs    r1, #0xa8\n"
"    mov     r2, sp\n"
"    bl      sub_fc297b4a\n"
"    ldr     r0, [r5, #0x24]\n"
"    movs    r3, #4\n"
"    movs    r1, #0xa2\n"
"    add.w   r2, r5, #8\n"
"    bl      sub_fc297b4a\n"
"    ldr     r0, [r5, #0x24]\n"
"    movs    r3, #4\n"
"    movs    r1, #0xa3\n"
"    add.w   r2, r5, #0xc\n"
"    bl      sub_fc297b4a\n"
"    ldr     r0, [r4, #0x28]\n"
"    lsls    r0, r0, #7\n"
"    movs    r2, #0xa\n"
"    umull   r2, r3, r0, r2\n"
"    strd    r0, r2, [r6, #0x44]\n"
"    umull   r0, r2, r0, fp\n"
"    str     r0, [r6, #0x4c]\n"
"    pop.w   {r0, r1, r2, r3, r4, r5, r6, r7, r8, sb, sl, fp, ip, pc}\n"
".ltorg\n"
    );
}

// below functions are for getting bitrate information during recording
// filesystem info only updates after recording stops

void __attribute__((naked,noinline)) sub_fc02167a_my() { // "APENDSTRM"
asm volatile (
"    push   {r0, lr}\n"
"    ldr    r0, [r0, #8]\n"
"    ldr    r0, [r0, #4]\n"
"    bl     getchunkinfo\n"
"    pop    {r0, lr}\n"
"    ldr    pc, =0xfc02167b\n"
);
}

void getchunkinfo(int *r0) { // for each model, firmware struct needs to be verified
    int m;
    unsigned int lsum = 0;
    m = *r0; // num of chunks
    int *cl = (int*)(*(r0+1));
    while (m>0) {
        // chunk properties, 3 words: addr, size, unknown
        lsum += *(cl+1);
        cl+=3;
        m--;
    }
    bitrate_calc(lsum);
}

// pointer to APENDSTRM handler is located in RAM
void replace_apendstrm() {
    *(int*)0x10E20 = (int)sub_fc02167a_my | 1;
}


