
#include "lolevel.h"
#include "platform.h"
#include "core.h"

// TODO:

#define USE_STUBS_NRFLAG 1
#define NR_AUTO (-1) // default value if NRTBL.SetDarkSubType not used is -1 (0 probably works the same), set to enable auto

#include "../../../generic/capt_seq.c"

char *current_raw_addr;
char *current_raw_alt_addr;
int current_raw_idx;

void captseq_get_raw_addr()
{
    char** raw_buffer_table = (char**)0xe05d8548;                       // e023dc6c
    current_raw_idx = *((int*)0x8578);                                  // e023dc6e
    current_raw_addr = raw_buffer_table[current_raw_idx];
    current_raw_alt_addr = raw_buffer_table[(current_raw_idx+1)&0xF];   // 16 buffers, select next one as alt
}

void clear_current_raw_addr(void)
{
    current_raw_addr = NULL;
}

// capt_seq_task 0xe0032f57
void __attribute__((naked,noinline)) capt_seq_task() {
    asm volatile (
            //capdis -f=chdk -s=0xe0032f57 -c=31 -stubs PRIMARY.BIN 0xe0000000
            "    push    {r3, r4, r5, r6, r7, lr}\n"
            "    movs    r6, #0\n"
            "    ldr     r4, =0x00057d2c\n"
            "    ldr     r5, =0x0000c098\n"
            "loc_e0032f5e:\n"
            "    movs    r2, #0\n"
            "    mov     r1, sp\n"
            "    ldr     r0, [r5, #8]\n"
            "    bl      sub_dffc9de0\n"
            "    lsls    r0, r0, #0x1f\n"
            "    beq     loc_e0032f80\n"
            "    movw    r2, #0x435\n"
            "    ldr     r1, =0xe0032b9c\n" //  *"SsShootTask.c"
            "    movs    r0, #0\n"
            "    bl      sub_dffc96f4\n"
            "    bl      sub_dffc95ae\n"
            "    pop     {r3, r4, r5, r6, r7, pc}\n"
            "loc_e0032f80:\n"
            "    ldr     r0, [sp]\n"
            "    ldr     r0, [r0]\n"
            "    cmp     r0, #1\n"
            "    beq     loc_e0032f98\n"
            "    cmp     r0, #0x2b\n"
            "    beq     loc_e0032f98\n"
            "    cmp     r0, #0x1f\n"
            "    beq     loc_e0032f98\n"
            "    cmp     r0, #0x23\n"
            "    beq     loc_e0032f98\n"
            "    bl      sub_e005333c\n"
            "loc_e0032f98:\n"
            "    ldr     r0, [sp]\n"
            "    ldr     r1, [r0]\n"
            "    cmp     r1, #0x33\n"
            "    bhs     loc_e0033080\n"

            //capdis -f=chdk -s=0xe0032fa1 -c=147 -stubs PRIMARY.BIN 0xe0000000
            "    tbb     [pc, r1]\n" // (jumptable r1 51 elements)
            "branchtable_e0032fa4:\n"
            "    .byte((loc_e0032fd8 - branchtable_e0032fa4) / 2)\n" // (case 0)
            "    .byte((loc_e0032fee - branchtable_e0032fa4) / 2)\n" // (case 1)
            "    .byte((loc_e0033008 - branchtable_e0032fa4) / 2)\n" // (case 2)
            "    .byte((loc_e0033016 - branchtable_e0032fa4) / 2)\n" // (case 3)
            "    .byte((loc_e0033010 - branchtable_e0032fa4) / 2)\n" // (case 4)
            "    .byte((loc_e0033020 - branchtable_e0032fa4) / 2)\n" // (case 5)
            "    .byte((loc_e003313a - branchtable_e0032fa4) / 2)\n" // (case 6)
            "    .byte((loc_e003313a - branchtable_e0032fa4) / 2)\n" // (case 7)
            "    .byte((loc_e0033026 - branchtable_e0032fa4) / 2)\n" // (case 8)
            "    .byte((loc_e0033036 - branchtable_e0032fa4) / 2)\n" // (case 9)
            "    .byte((loc_e003303e - branchtable_e0032fa4) / 2)\n" // (case 10)
            "    .byte((loc_e0033044 - branchtable_e0032fa4) / 2)\n" // (case 11)
            "    .byte((loc_e003313a - branchtable_e0032fa4) / 2)\n" // (case 12)
            "    .byte((loc_e003304c - branchtable_e0032fa4) / 2)\n" // (case 13)
            "    .byte((loc_e0033052 - branchtable_e0032fa4) / 2)\n" // (case 14)
            "    .byte((loc_e0033058 - branchtable_e0032fa4) / 2)\n" // (case 15)
            "    .byte((loc_e003305e - branchtable_e0032fa4) / 2)\n" // (case 16)
            "    .byte((loc_e0033064 - branchtable_e0032fa4) / 2)\n" // (case 17)
            "    .byte((loc_e003313a - branchtable_e0032fa4) / 2)\n" // (case 18)
            "    .byte((loc_e003306a - branchtable_e0032fa4) / 2)\n" // (case 19)
            "    .byte((loc_e0033070 - branchtable_e0032fa4) / 2)\n" // (case 20)
            "    .byte((loc_e0033076 - branchtable_e0032fa4) / 2)\n" // (case 21)
            "    .byte((loc_e003307a - branchtable_e0032fa4) / 2)\n" // (case 22)
            "    .byte((loc_e0033082 - branchtable_e0032fa4) / 2)\n" // (case 23)
            "    .byte((loc_e0033088 - branchtable_e0032fa4) / 2)\n" // (case 24)
            "    .byte((loc_e003308e - branchtable_e0032fa4) / 2)\n" // (case 25)
            "    .byte((loc_e0033094 - branchtable_e0032fa4) / 2)\n" // (case 26)
            "    .byte((loc_e003309a - branchtable_e0032fa4) / 2)\n" // (case 27)
            "    .byte((loc_e00330a2 - branchtable_e0032fa4) / 2)\n" // (case 28)
            "    .byte((loc_e00330a8 - branchtable_e0032fa4) / 2)\n" // (case 29)
            "    .byte((loc_e00330ae - branchtable_e0032fa4) / 2)\n" // (case 30)
            "    .byte((loc_e00330b2 - branchtable_e0032fa4) / 2)\n" // (case 31)
            "    .byte((loc_e00330ba - branchtable_e0032fa4) / 2)\n" // (case 32)
            "    .byte((loc_e003313a - branchtable_e0032fa4) / 2)\n" // (case 33)
            "    .byte((loc_e00330c0 - branchtable_e0032fa4) / 2)\n" // (case 34)
            "    .byte((loc_e00330c6 - branchtable_e0032fa4) / 2)\n" // (case 35)
            "    .byte((loc_e00330cc - branchtable_e0032fa4) / 2)\n" // (case 36)
            "    .byte((loc_e00330d2 - branchtable_e0032fa4) / 2)\n" // (case 37)
            "    .byte((loc_e00330d8 - branchtable_e0032fa4) / 2)\n" // (case 38)
            "    .byte((loc_e00330e0 - branchtable_e0032fa4) / 2)\n" // (case 39)
            "    .byte((loc_e00330e6 - branchtable_e0032fa4) / 2)\n" // (case 40)
            "    .byte((loc_e003313a - branchtable_e0032fa4) / 2)\n" // (case 41)
            "    .byte((loc_e003311c - branchtable_e0032fa4) / 2)\n" // (case 42)
            "    .byte((loc_e0033122 - branchtable_e0032fa4) / 2)\n" // (case 43)
            "    .byte((loc_e0033106 - branchtable_e0032fa4) / 2)\n" // (case 44)
            "    .byte((loc_e0033148 - branchtable_e0032fa4) / 2)\n" // (case 45)
            "    .byte((loc_e003313a - branchtable_e0032fa4) / 2)\n" // (case 46)
            "    .byte((loc_e003313a - branchtable_e0032fa4) / 2)\n" // (case 47)
            "    .byte((loc_e003313a - branchtable_e0032fa4) / 2)\n" // (case 48)
            "    .byte((loc_e003312e - branchtable_e0032fa4) / 2)\n" // (case 49)
            "    .byte((loc_e0033134 - branchtable_e0032fa4) / 2)\n" // (case 50)
            ".align 1\n"
            "loc_e0032fd8:\n"
            "    ldr     r0, [r0, #0xc]\n"
            "    bl      sub_e0039274\n"
            "    BL      shooting_expo_param_override\n" // +
            "    bl      sub_e004f1e4\n"
            "    ldr     r0, [r4, #0x28]\n"
            "    cmp     r0, #0\n"
            "    beq     loc_e0032fec\n"
            "    bl      sub_e00464ae_my\n" // -> nr?, remote hook, raw hook (quick, no half press)
            "loc_e0032fec:\n"
            "    b       loc_e0033148\n"
            "loc_e0032fee:\n"
            "    ldr     r0, [r0, #0x10]\n"
            "    bl      sub_e004644a_my\n" // -> nr?, remote hook, raw hook
            "    b       loc_e0033148\n"
            "loc_e0033008:\n"
            "    movs    r0, #1\n"
            "    bl      sub_e00395a2\n"
            "    b       loc_e0033148\n"
            "loc_e0033010:\n"
            "    bl      sub_e0038f62\n"
            "    b       loc_e003301c\n"
            "loc_e0033016:\n"
            "    ldr     r0, [r0, #0xc]\n"
            "    bl      sub_e003925c\n"
            "loc_e003301c:\n"
            "    str     r6, [r4, #0x28]\n"
            "    b       loc_e0033148\n"
            "loc_e0033020:\n"
            "    bl      sub_e0039262\n"
            "    b       loc_e0033148\n"
            "loc_e0033026:\n"
            "    bl      sub_e0039532\n"
            "    bl      sub_e004f1e4\n"
            "    movs    r0, #0\n"
            "    bl      sub_e0297bcc\n"
            "    b       loc_e0033148\n"
            "loc_e0033036:\n"
            "    ldr     r0, [r4, #0x54]\n"
            "    bl      sub_e0039b92\n"
            "    b       loc_e0033148\n"
            "loc_e003303e:\n"
            "    bl      sub_e0039dfc\n"
            "    b       loc_e0033148\n"
            "loc_e0033044:\n"
            "    ldr     r0, [r0, #0xc]\n"
            "    bl      sub_e0039e48\n"
            "    b       loc_e0033148\n"
            "loc_e003304c:\n"
            "    bl      sub_e003a030\n"
            "    b       loc_e0033148\n"
            "loc_e0033052:\n"
            "    bl      sub_e003a41c\n"
            "    b       loc_e0033148\n"
            "loc_e0033058:\n"
            "    bl      sub_e003a4b0\n"
            "    b       loc_e0033148\n"
            "loc_e003305e:\n"
            "    bl      sub_e003bfc0\n"
            "    b       loc_e0033148\n"
            "loc_e0033064:\n"
            "    bl      sub_e003c15c\n"
            "    b       loc_e0033148\n"
            "loc_e003306a:\n"
            "    bl      sub_e003c1f8\n"
            "    b       loc_e0033148\n"
            "loc_e0033070:\n"
            "    bl      sub_e003c274\n"
            "    b       loc_e0033148\n"
            "loc_e0033076:\n"
            "    movs    r0, #0\n"
            "    b       loc_e003309c\n"
            "loc_e003307a:\n"
            "    bl      sub_e003c57a\n"
            "    b       loc_e0033148\n"
            "loc_e0033080:\n"
            "    b       loc_e003313a\n"
            "loc_e0033082:\n"
            "    bl      sub_e003c5da\n"
            "    b       loc_e0033148\n"
            "loc_e0033088:\n"
            "    bl      sub_e003c5de\n"
            "    b       loc_e0033148\n"
            "loc_e003308e:\n"
            "    bl      sub_e003c5f0\n"
            "    b       loc_e0033148\n"
            "loc_e0033094:\n"
            "    bl      sub_e003c674\n"
            "    b       loc_e0033148\n"
            "loc_e003309a:\n"
            "    movs    r0, #1\n"
            "loc_e003309c:\n"
            "    bl      sub_e003c458\n"
            "    b       loc_e0033148\n"
            "loc_e00330a2:\n"
            "    bl      sub_e003c720\n"
            "    b       loc_e0033148\n"
            "loc_e00330a8:\n"
            "    bl      sub_e0039672\n"
            "    b       loc_e0033148\n"
            "loc_e00330ae:\n"
            "    movs    r0, #0\n"
            "    b       loc_e00330b4\n"
            "loc_e00330b2:\n"
            "    ldr     r0, [r0, #0xc]\n"
            "loc_e00330b4:\n"
            "    bl      sub_e00396f2\n"
            "    b       loc_e0033148\n"
            "loc_e00330ba:\n"
            "    bl      sub_e003c37c\n"
            "    b       loc_e0033148\n"
            "loc_e00330c0:\n"
            "    bl      sub_e003c3e8\n"
            "    b       loc_e0033148\n"
            "loc_e00330c6:\n"
            "    bl      sub_e0046668\n"
            "    b       loc_e0033148\n"
            "loc_e00330cc:\n"
            "    bl      sub_e003afdc\n"
            "    b       loc_e0033148\n"
            "loc_e00330d2:\n"
            "    bl      sub_e003b096\n"
            "    b       loc_e0033148\n"
            "loc_e00330d8:\n"
            "    ldr     r0, [r0, #0xc]\n"
            "    bl      sub_e003c7d8\n"
            "    b       loc_e0033148\n"
            "loc_e00330e0:\n"
            "    bl      sub_e003c840\n"
            "    b       loc_e0033148\n"
            "loc_e00330e6:\n"
            "    bl      sub_e00361dc\n"
            "    ldrh.w  r0, [r4, #0x1a0]\n"
            "    cmp     r0, #4\n"
            "    beq     loc_e00330fc\n"
            "    ldrh    r0, [r4]\n"
            "    sub.w   r1, r0, #0x8200\n"
            "    subs    r1, #0x37\n"
            "    bne     loc_e0033148\n"
            "loc_e00330fc:\n"
            "    bl      sub_e003b096\n"
            "    bl      sub_e003b410\n"
            "    b       loc_e0033148\n"
            "loc_e0033106:\n"
            "    bl      sub_e003a6ba\n"
            "    movs    r0, #1\n"
            "    bl      sub_e0035df4\n"
            "    cbnz    r0, loc_e0033148\n"
            "    movs    r1, #0\n"
            "    movs    r0, #6\n"
            "    bl      sub_e003c978\n"
            "    b       loc_e0033148\n"
            "loc_e003311c:\n"
            "    movs    r2, #0\n"
            "    movs    r1, #0x11\n"
            "    b       loc_e0033126\n"
            "loc_e0033122:\n"
            "    movs    r2, #0\n"
            "    movs    r1, #0x10\n"
            "loc_e0033126:\n"
            "    movs    r0, #0\n"
            "    bl      sub_e004ff4a\n"
            "    b       loc_e0033148\n"
            "loc_e003312e:\n"
            "    bl      sub_e003d212\n"
            "    b       loc_e0033148\n"
            "loc_e0033134:\n"
            "    bl      sub_e003d214\n"
            "    b       loc_e0033148\n"
            "loc_e003313a:\n"
            "    movw    r2, #0x566\n"
            "    ldr     r1, =0xe0032b9c\n" //  *"SsShootTask.c"
            "    movs    r0, #0\n"
            "    bl      sub_dffc96f4\n"
            "loc_e0033148:\n"
            "    BL      capt_seq_hook_set_nr\n" //  dark frame control
            "    ldr     r0, [sp]\n"
            "    ldr     r1, [r0, #4]\n"
            "    ldr     r0, [r5, #4]\n"
            "    bl      sub_dffc9938\n"
            "    ldr     r7, [sp]\n"
            "    ldr     r0, [r7, #8]\n"
            "    cbnz    r0, loc_e0033164\n"
            "    movs    r2, #0xff\n"
            "    ldr     r1, =0xe0032bb8\n" //  *"SsShootTask.c"
            "    movs    r0, #0\n"
            "    bl      sub_dffc96f4\n"
            "loc_e0033164:\n"
            "    str     r6, [r7, #8]\n"
            "    b       loc_e0032f5e\n"
    );
}

//e00464ae
void __attribute__((naked,noinline)) sub_e00464ae_my() {
    asm volatile (
            //capdis -f=chdk -s=0xe00464af -c=46 -stubs PRIMARY.BIN 0xe0000000
            "    push    {r3, r4, r5, r6, r7, lr}\n"
            "    bl      sub_e0050788\n"
            "    mov     r6, r0\n"
            "    movs    r0, #0xc\n"
            "    bl      sub_e02f079c\n"
            "    ldr     r5, =0x00012134\n"
            "    lsls    r0, r0, #0x1f\n"
            "    mov.w   r4, #1\n"
            "    bne     loc_e0046522\n"
            "    movs    r2, #2\n"
            "    mov     r1, sp\n"
            "    movw    r0, #0x113\n"
            "    bl      sub_e036af68\n"
            "    lsls    r0, r0, #0x1f\n"
            "    beq     loc_e00464e2\n"
            "    movs    r0, #0\n"
            "    mov.w   r2, #0x1b4\n"
            "    ldr     r1, =0xe00465a8\n" //  *"SsCaptureCtrl.c"
            "    bl      sub_dffc96f4\n"
            "loc_e00464e2:\n"
            "    ldrsh.w r0, [sp]\n"
            "    bl      sub_e049140e\n"
            "    bl      sub_e04911be\n"
            "    cmp     r0, #1\n"
            "    bls     loc_e0046526\n"
            "    movs    r0, #0\n"
            "    bl      sub_e04912dc\n"
            "    bl      sub_e03817dc\n"
            "    bl      sub_e0039268\n"
            "    mov     r0, r6\n"
            "    bl      sub_e0051f14\n"
            "    movs    r2, #4\n"
            "    movs    r0, #0x46\n"
            "    add.w   r1, r6, #8\n"
            "    bl      sub_e036ae24\n"
            "    mov     r0, r6\n"
            "    bl      sub_e004b410\n"
            "    mov     r0, r6\n"
            "    bl      sub_e005348c_my\n" // Patched
            "    lsls    r0, r0, #0x1f\n"
            "    beq     loc_e0046524\n" //  return
            "loc_e0046522:\n"
            "    str     r4, [r5]\n"
            "loc_e0046524:\n"
            "    pop     {r3, r4, r5, r6, r7, pc}\n"
            "loc_e0046526:\n"
            "    str     r4, [r5]\n"
            "    bl      sub_e004fc16\n"
            "    bl      sub_e02f07dc\n"
            "    pop     {r3, r4, r5, r6, r7, pc}\n"
    );
}

//e004644a
void __attribute__((naked,noinline)) sub_e004644a_my() {
    asm volatile (
            //capdis -f=chdk -s=0xe004644b -c=41 -stubs PRIMARY.BIN 0xe0000000
            "    push    {r4, r5, r6, lr}\n"
            "    mov     r6, r0\n"
            "    ldr     r5, =0x00057d2c\n"
            "    movs    r4, #0\n"
            "    mov.w   r3, #0x120\n"
            "    ldr     r0, [r5, #0x28]\n"
            "    cbz     r0, loc_e0046482\n"
            "    ldr.w   r2, [r6, #0x138]\n"
            "    ldr     r1, =0xe00465c0\n" //  *"CaptCtrl:Quick(%d)"
            "    mov     r0, r3\n"
            "    bl      sub_e036b640\n"
            "    ldr     r0, =0x00012134\n"
            "    ldr     r0, [r0]\n"
            "    cbz     r0, loc_e004646e\n"
            "    movs    r4, #0x1d\n"
            "loc_e004646e:\n"
            "    movs    r1, #2\n"
            "    mov     r2, r6\n"
            "    mov     r0, r4\n"
            "    bl      sub_e004ff4a\n"
            "    mov     r1, r4\n"
            "    mov     r0, r6\n"
            "    bl      sub_e00531c8\n"
            "    b       loc_e00464a8\n"
            "loc_e0046482:\n"
            "    ldr     r1, =0xe00465d8\n" //  *"CaptCtrl:ExecCapt"
            "    mov     r0, r3\n"
            "    bl      sub_e036b640\n"
            "    mov     r0, r6\n"
            "    bl      sub_e004626a_my\n" // Patched
            "    mov     r4, r0\n"
            "    lsls    r0, r0, #0x1f\n"
            "    beq     loc_e00464a8\n"
            "    movs    r1, #2\n"
            "    mov     r2, r6\n"
            "    mov     r0, r4\n"
            "    bl      sub_e004ff4a\n"
            "    mov     r1, r4\n"
            "    mov     r0, r6\n"
            "    bl      sub_e00532fe\n"
            "loc_e00464a8:\n"
            "    movs    r0, #0\n"
            "    str     r0, [r5, #0x28]\n"
            "    pop     {r4, r5, r6, pc}\n"
    );
}

//e004626a
void __attribute__((naked,noinline)) sub_e004626a_my() {
    asm volatile (
            //capdis -f=chdk -s=0xe004626b -c=178 -stubs PRIMARY.BIN 0xe0000000
            "    push.w  {r2, r3, r4, r5, r6, r7, r8, lr}\n"
            "    mov     r4, r0\n"
            "    bl      sub_e0051f14\n"
            "    ldr     r6, =0x00057d2c\n"
            "    ldr.w   r0, [r6, #0x108]\n"
            "    cbz     r0, loc_e0046284\n"
            "    ldr     r0, [r4, #0xc]\n"
            "    cmp     r0, #1\n"
            "    beq     loc_e0046292\n"
            "    b       loc_e00462a2\n"
            "loc_e0046284:\n"
            "    ldrh.w  r0, [r6, #0x19e]\n"
            "    cmp     r0, #3\n"
            "    beq     loc_e0046292\n"
            "    ldr     r0, [r4, #8]\n"
            "    cmp     r0, #1\n"
            "    bhi     loc_e00462a2\n"
            "loc_e0046292:\n"
            "    movs    r0, #0xc\n"
            "    bl      sub_e02f079c\n"
            "    lsls    r0, r0, #0x1f\n"
            "    beq     loc_e00462a2\n"
            "loc_e004629c:\n"
            "    bl      sub_e004fc16\n"
            "    b       loc_e0046302\n" //  return 0x1
            "loc_e00462a2:\n"
            "    ldr.w   r0, [r6, #0xec]\n"
            "    cbz     r0, loc_e00462c2\n"
            "    ldrh.w  r0, [r6, #0x19e]\n"
            "    cmp     r0, #3\n"
            "    beq     loc_e00462b6\n"
            "    ldr     r0, [r4, #8]\n"
            "    cmp     r0, #1\n"
            "    bhi     loc_e00462f2\n"
            "loc_e00462b6:\n"
            "    ldr.w   r0, [r6, #0x108]\n"
            "    cbz     r0, loc_e00462c2\n"
            "    ldr     r0, [r4, #0xc]\n"
            "    cmp     r0, #1\n"
            "    bhi     loc_e00462f2\n"
            "loc_e00462c2:\n"
            "    movs    r2, #2\n"
            "    mov     r1, sp\n"
            "    movw    r0, #0x113\n"
            "    bl      sub_e036af68\n"
            "    lsls    r0, r0, #0x1f\n"
            "    beq     loc_e00462dc\n"
            "    movs    r2, #0xe5\n"
            "    movs    r0, #0\n"
            "    ldr     r1, =0xe00465a8\n" //  *"SsCaptureCtrl.c"
            "    bl      sub_dffc96f4\n"
            "loc_e00462dc:\n"
            "    ldrsh.w r0, [sp]\n"
            "    bl      sub_e049140e\n"
            "    bl      sub_e04911be\n"
            "    cmp     r0, #1\n"
            "    bls     loc_e00462fa\n"
            "    movs    r0, #0\n"
            "    bl      sub_e04912dc\n"
            "loc_e00462f2:\n"
            "    ldr.w   r0, [r6, #0x1cc]\n"
            "    cbnz    r0, loc_e004630e\n"
            "    b       loc_e0046308\n"
            "loc_e00462fa:\n"
            "    bl      sub_e004fc16\n"
            "    bl      sub_e02f07dc\n"
            "loc_e0046302:\n"
            "    movs    r0, #1\n"
            "loc_e0046304:\n"
            "    pop.w   {r2, r3, r4, r5, r6, r7, r8, pc}\n"
            "loc_e0046308:\n"
            "    ldr.w   r0, [r6, #0x1c8]\n"
            "    cbz     r0, loc_e0046326\n"
            "loc_e004630e:\n"
            "    ldr     r0, [r4, #8]\n"
            "    cmp     r0, #1\n"
            "    beq     loc_e0046320\n"
            "    movs    r0, #1\n"
            "    bl      sub_e0035df4\n"
            "    lsls    r0, r0, #0x1f\n"
            "    bne     loc_e004629c\n"
            "    b       loc_e0046326\n"
            "loc_e0046320:\n"
            "    movs    r0, #0x64\n"
            "    bl      sub_dffc9292\n"
            "loc_e0046326:\n"
            "    mov     r0, r4\n"
            "    bl      sub_e00396b8\n"
            "    lsls    r1, r0, #0x1f\n"
            "    bne     loc_e0046304\n" //  return
            "    ldr     r7, =0x00057f40\n"
            "    ldr     r0, [r7]\n"
            "    cbz     r0, loc_e004633c\n"
            "    mov     r0, r4\n"
            "    bl      sub_e005341c\n"
            "loc_e004633c:\n"
            "    mov     r0, r4\n"
            "    bl      sub_e004965e\n"
            "    mov     r5, r0\n"
            "    lsls    r0, r0, #0x1f\n"
            "    bne     loc_e0046446\n"
            "    bl      sub_e03817dc\n"
            "    bl      sub_e0039268\n"
            "    mov     r0, r4\n"
            "    bl      sub_e004b410\n"
            "    ldr.w   r0, [r6, #0x12c]\n"
            "    cbnz    r0, loc_e004636a\n"
            "    ldrh.w  r0, [r6, #0x19e]\n"
            "    cmp     r0, #3\n"
            "    beq     loc_e004636a\n"
            "    ldr     r0, [r4, #8]\n"
            "    cmp     r0, #1\n"
            "    bhi     loc_e0046370\n"
            "loc_e004636a:\n"
            "    movs    r0, #2\n"
            "    bl      sub_e003e64e\n"
            "loc_e0046370:\n"
            "    ldr.w   r0, [r6, #0x9c]\n"
            "    cbz     r0, loc_e00463d4\n"
            "    ldrh.w  r0, [r6, #0x19e]\n"
            "    mov.w   r8, #0x800\n"
            "    cmp     r0, #3\n"
            "    beq     loc_e004639e\n"
            "    ldr     r0, [r4, #8]\n"
            "    cmp     r0, #1\n"
            "    bls     loc_e004639e\n"
            "    bl      sub_e005157e\n"
            "    mov.w   r1, #0x13a\n"
            "    ldr     r3, =0xe00465a8\n" //  *"SsCaptureCtrl.c"
            "    str     r1, [sp]\n"
            "    movw    r2, #0x3a98\n"
            "    mov     r1, r8\n"
            "    bl      sub_e02f0954\n"
            "loc_e004639e:\n"
            "    movs    r2, #4\n"
            "    add     r1, sp, #4\n"
            "    movw    r0, #0x18b\n"
            "    bl      sub_e036af68\n"
            "    lsls    r0, r0, #0x1f\n"
            "    beq     loc_e00463ba\n"
            "    movs    r0, #0\n"
            "    mov.w   r2, #0x13e\n"
            "    ldr     r1, =0xe00465a8\n" //  *"SsCaptureCtrl.c"
            "    bl      sub_dffc96f4\n"
            "loc_e00463ba:\n"
            "    ldr     r0, [sp, #4]\n"
            "    cbz     r0, loc_e00463e2\n"
            "    bl      sub_e005157e\n"
            "    mov     r1, r8\n"
            "    bl      sub_dffc9966\n"
            "    ldr     r2, =0xe0046259\n"
            "    mov     r3, r8\n"
            "    ldr     r0, [sp, #4]\n"
            "    mov     r1, r2\n"
            "    bl      sub_e0370142\n"
            "loc_e00463d4:\n"
            "    ldr.w   r0, [r6, #0xa4]\n"
            "    cbz     r0, loc_e00463ee\n"
            "    mov     r0, r4\n"
            "    bl      sub_e0053cae\n"
            "    b       loc_e0046432\n"
            "loc_e00463e2:\n"
            "    bl      sub_e005157e\n"
            "    mov     r1, r8\n"
            "    bl      sub_dffc9938\n"
            "    b       loc_e00463d4\n"
            "loc_e00463ee:\n"
            "    ldr.w   r0, [r6, #0xa8]\n"
            "    cbz     r0, loc_e00463fc\n"
            "    mov     r0, r4\n"
            "    bl      sub_e0053940\n"
            "    b       loc_e0046432\n"
            "loc_e00463fc:\n"
            "    ldr.w   r0, [r6, #0xac]\n"
            "    cbz     r0, loc_e004640a\n"
            "    mov     r0, r4\n"
            "    bl      sub_e0053f92\n"
            "    b       loc_e0046432\n"
            "loc_e004640a:\n"
            "    ldr.w   r0, [r6, #0xb0]\n"
            "    cbz     r0, loc_e004641c\n"
            "    ldr     r0, [r7]\n"
            "    cbz     r0, loc_e004641c\n"
            "    mov     r0, r4\n"
            "    bl      sub_e005424e\n"
            "    b       loc_e0046432\n"
            "loc_e004641c:\n"
            "    ldr.w   r0, [r6, #0xb4]\n"
            "    cmp     r0, #0\n"
            "    mov     r0, r4\n"
            "    beq     loc_e004642e\n"
            "    bl      sub_e005452a\n"
            "    b       loc_e0046432\n"
            "    b       loc_e0046446\n"
            "loc_e004642e:\n"
            "    bl      sub_e005348c_my\n" // Patched
            "loc_e0046432:\n"
            "    ldr.w   r0, [r6, #0x1cc]\n"
            "    cbnz    r0, loc_e004643e\n"
            "    ldr.w   r0, [r6, #0x1c8]\n"
            "    cbz     r0, loc_e0046446\n"
            "loc_e004643e:\n"
            "    movs    r1, #0\n"
            "    movs    r0, #1\n"
            "    bl      sub_e0035e3c\n"
            "loc_e0046446:\n"
            "    mov     r0, r5\n"
            "    b       loc_e0046304\n" //  return
    );
}

//e005348c
void __attribute__((naked,noinline)) sub_e005348c_my() {
    asm volatile (
            //capdis -f=chdk -s=0xe005348d -c=293 -stubs PRIMARY.BIN 0xe0000000
            "    push.w  {r0, r1, r2, r3, r4, r5, r6, r7, r8, sb, sl, lr}\n"
            "    mov     r4, r0\n"
            "    BL      captseq_get_raw_addr\n"  // +
            "    ldr     r7, =0x00057d2c\n"
            "    ldr.w   r0, [r7, #0x104]\n"
            "    cbz     r0, loc_e00534a8\n"
            "    ldrh.w  r0, [r7, #0x19e]\n"
            "    cmp     r0, #3\n"
            "    beq     loc_e00534a8\n"
            "    ldr     r0, [r4, #8]\n"
            "    cmp     r0, #1\n"
            "    bhi     loc_e00534ae\n"
            "loc_e00534a8:\n"
            "    mov     r0, r4\n"
            "    bl      sub_e0051e2a\n"
            "loc_e00534ae:\n"
            "    mov     r0, r4\n"
            "    bl      sub_e0051fdc\n"
            "    ldr.w   r0, [r7, #0x168]\n"
            "    cbz     r0, loc_e00534c8\n"
            "    ldrh.w  r0, [r7, #0x19e]\n"
            "    cmp     r0, #3\n"
            "    beq     loc_e00534c8\n"
            "    ldr     r0, [r4, #8]\n"
            "    cmp     r0, #1\n"
            "    bhi     loc_e00534d2\n"
            "loc_e00534c8:\n"
            "    mov     r0, r4\n"
            "    bl      sub_e004b35c\n"
            "    bl      sub_e003ccf0\n"
            "loc_e00534d2:\n"
            "    ldr.w   r0, [r7, #0x98]\n"
            "    cbnz    r0, loc_e00534f0\n"
            "    ldrh.w  r0, [r7, #0x19e]\n"
            "    cmp     r0, #3\n"
            "    beq     loc_e00534e6\n"
            "    ldr     r0, [r4, #8]\n"
            "    cmp     r0, #1\n"
            "    bhi     loc_e00534f0\n"
            "loc_e00534e6:\n"
            "    movs    r0, #1\n"
            "    bl      sub_e0039694\n"
            "    bl      sub_e003c8ca\n"
            "loc_e00534f0:\n"
            "    movs    r2, #4\n"
            "    add     r1, sp, #8\n"
            "    mov.w   r0, #0x13a\n"
            "    bl      sub_e036af68\n"
            "    lsls    r0, r0, #0x1f\n"
            "    beq     loc_e005350c\n"
            "    movs    r0, #0\n"
            "    movw    r2, #0x191\n"
            "    ldr     r1, =0xe005381c\n" //  *"SsStandardCaptureSeq.c"
            "    bl      sub_dffc96f4\n"
            "loc_e005350c:\n"
            "    ldr     r0, [sp, #8]\n"
            "    ubfx    r0, r0, #8, #8\n"
            "    cmp     r0, #6\n"
            "    beq     loc_e0053586\n"
            "    mov     r1, r4\n"
            "    ldr     r0, =0xe004b013\n"
            "loc_e005351a:\n"
            "    bl      sub_e0066cf0\n"
            "    movs    r2, #2\n"
            "    add     r1, sp, #0xc\n"
            "    movw    r0, #0x115\n"
            "    bl      sub_e036af68\n"
            "    lsls    r0, r0, #0x1f\n"
            "    beq     loc_e005353a\n"
            "    movs    r0, #0\n"
            "    mov.w   r2, #0x19a\n"
            "    ldr     r1, =0xe005381c\n" //  *"SsStandardCaptureSeq.c"
            "    bl      sub_dffc96f4\n"
            "loc_e005353a:\n"
            "    ldr.w   r0, [r7, #0x104]\n"
            "    cbz     r0, loc_e005356e\n"
            "    ldrh.w  r0, [r7, #0x19e]\n"
            "    cmp     r0, #3\n"
            "    beq     loc_e005354e\n"
            "    ldr     r0, [r4, #8]\n"
            "    cmp     r0, #1\n"
            "    bhi     loc_e005356e\n"
            "loc_e005354e:\n"
            "    movs    r0, #1\n"
            "    movw    r5, #0x169\n"
            "    strh.w  r0, [sp]\n"
            "    movs    r2, #2\n"
            "    mov     r1, sp\n"
            "    mov     r0, r5\n"
            "    bl      sub_e036ae24\n"
            "    ldr     r0, [r4, #0x1c]\n"
            "    movs    r3, #2\n"
            "    mov     r2, sp\n"
            "    mov     r1, r5\n"
            "    bl      sub_e036b28a\n"
            "loc_e005356e:\n"
            "    ldr.w   r0, [r7, #0x188]\n"
            "    cbz     r0, loc_e0053578\n"
            "    bl      sub_e004b294\n"
            "loc_e0053578:\n"
            "    movs    r0, #0\n"
            "    bl      sub_e0035dec\n" //  return
            "    ldr     r0, =0x00057f40\n"
            "    ldr     r0, [r0]\n"
            "    cbz     r0, loc_e005358c\n"
            "    b       loc_e0053592\n"
            "loc_e0053586:\n"
            "    ldr     r0, =0xe0053409\n"
            "    movs    r1, #0\n"
            "    b       loc_e005351a\n"
            "loc_e005358c:\n"
            "    mov     r0, r4\n"
            "    bl      sub_e005341c\n"
            "loc_e0053592:\n"
            "    mov     r0, r4\n"
            "    bl      sub_e004b4e0\n"
            "    movs    r2, #4\n"
            "    movs    r0, #0x92\n"
            "    add     r1, sp, #4\n"
            "    bl      sub_e036af68\n"
            "    lsls    r0, r0, #0x1f\n"
            "    beq     loc_e00535b2\n"
            "    movs    r0, #0\n"
            "    movw    r2, #0x1c3\n"
            "    ldr     r1, =0xe005381c\n" //  *"SsStandardCaptureSeq.c"
            "    bl      sub_dffc96f4\n"
            "loc_e00535b2:\n"
            "    ldr     r1, =0x00037e84\n"
            "    ldr     r0, [sp, #4]\n"
            "    str     r0, [r1]\n"
            "    ldr.w   r0, [r7, #0xc0]\n"
            "    cbnz    r0, loc_e00535c2\n"
            "    bl      sub_e0035ea8\n"
            "loc_e00535c2:\n"
            "    bl      sub_e004b572\n"
            "    movs    r1, #0\n"
            "    mov     r0, r4\n"
            "    bl      sub_e00538fa\n"
            "    mov     r5, r0\n"
            "    BL      wait_until_remote_button_is_released\n"    // + remote hook
            "    ldr     r0, [sp, #8]\n"
            "    ubfx    r0, r0, #8, #8\n"
            "    cmp     r0, #6\n"
            "    beq     loc_e0053622\n"
            "    ldr     r6, =0xe004b275\n"
            "loc_e00535dc:\n"
            "    ldrh    r0, [r4, #0x18]\n"
            "    ldr.w   r8, =0xfffff3a0\n"
            "    cbz     r0, loc_e0053626\n"
            "    cmp     r0, #1\n"
            "    beq     loc_e005363c\n"
            "    cmp     r0, #4\n"
            "    beq     loc_e0053626\n"
            "    movs    r0, #0\n"
            "    mov.w   r2, #0x210\n"
            "    ldr     r1, =0xe005381c\n" //  *"SsStandardCaptureSeq.c"
            "    bl      sub_dffc96f4\n"
            "    movs    r6, #0x1d\n"
            "loc_e00535fa:\n"
            "    ldrsh.w r0, [sp, #0xc]\n"
            "    cmp     r0, r8\n"
            "    beq     loc_e0053614\n"
            "    bl      sub_e0066cbe\n"
            "    cbz     r0, loc_e0053614\n"
            "    movs    r2, #1\n"
            "    movs    r1, #0\n"
            "    movs    r0, #0x46\n"
            "    bl      sub_e0299940\n"
            "    movs    r6, #1\n"
            "loc_e0053614:\n"
            "    bl      sub_e004b576\n"
            "    ldr.w   r8, =0xe0053409\n"
            "    lsls    r0, r6, #0x1f\n"
            "    beq     loc_e00536bc\n"
            "    b       loc_e0053730\n"
            "loc_e0053622:\n"
            "    ldr     r6, =0xe004b25f\n"
            "    b       loc_e00535dc\n"
            "loc_e0053626:\n"
            "    str     r5, [sp]\n"
            "    mov     r3, r6\n"
            "    ldr     r1, [r4, #0x64]\n"
            "    mov     r0, r4\n"
            "    ldr     r2, [sp, #4]\n"
            "    bl      sub_e004ae3e\n"
            "    mov     r6, r0\n"
            "    bl      sub_e043e5e2\n"
            "    b       loc_e00535fa\n"
            "loc_e005363c:\n"
            "    ldr.w   r0, [r7, #0xc0]\n"
            "    cbz     r0, loc_e005364e\n"
            "    movs    r0, #0\n"
            "    movw    r2, #0x1e7\n"
            "    ldr     r1, =0xe005381c\n" //  *"SsStandardCaptureSeq.c"
            "    bl      sub_dffc96f4\n"
            "loc_e005364e:\n"
            "    str     r5, [sp]\n"
            "    mov     r3, r6\n"
            "    ldr     r1, [r4, #0x64]\n"
            "    mov     r0, r4\n"
            "    ldr     r2, [sp, #4]\n"
            "    bl      sub_e004aeba\n"
            "    mov     r6, r0\n"
            "    ldrsh.w r0, [sp, #0xc]\n"
            "    cmp     r0, r8\n"
            "    beq     loc_e005366c\n"
            "    bl      sub_e0066cbe\n"
            "    cbnz    r0, loc_e0053676\n"
            "loc_e005366c:\n"
            "    movs    r2, #1\n"
            "    movs    r1, #0\n"
            "    movs    r0, #0x45\n"
            "    bl      sub_e0299940\n"
            "loc_e0053676:\n"
            "    lsls    r0, r6, #0x1f\n"
            "    bne     loc_e00535fa\n"
            "    ldr.w   r0, [r7, #0xfc]\n"
            "    cbz     r0, loc_e0053690\n"
            "    ldr     r1, [r4, #8]\n"
            "    ldr     r2, =0x00229618\n"
            "    ldr     r0, [r4, #0x64]\n"
            "    add.w   r1, r2, r1, lsl #2\n"
            "    str     r0, [r1, #-0x4]\n"
            "    b       loc_e00536b6\n"
            "loc_e0053690:\n"
            "    ldr     r0, =0xe0053409\n"
            "    movs    r1, #0\n"
            "    bl      sub_e0066cf0\n"
            "    movs    r1, #1\n"
            "    mov     r0, r4\n"
            "    bl      sub_e00538fa\n"
            "    mov     r5, r0\n"
            "    ldr     r0, [sp, #4]\n"
            "    bl      sub_e004b2fe\n"
            "    ldr     r1, [r4, #0x64]\n"
            "    mov     r3, r5\n"
            "    ldr     r2, [sp, #4]\n"
            "    mov     r0, r4\n"
            "    bl      sub_e004af2c\n"
            "    mov     r6, r0\n"
            "loc_e00536b6:\n"
            "    bl      sub_e004ade6\n"
            "    b       loc_e00535fa\n"
            "loc_e00536bc:\n"
            "    ldr.w   r0, [r7, #0x104]\n"
            "    cbnz    r0, loc_e00536fc\n"
            "    ldr.w   r0, [r7, #0x1cc]\n"
            "    cbnz    r0, loc_e00536ce\n"
            "    ldr.w   r0, [r7, #0x1c8]\n"
            "    cbz     r0, loc_e00536e6\n"
            "loc_e00536ce:\n"
            "    ldrh.w  r0, [r7, #0x1ec]\n"
            "    cmp     r0, #1\n"
            "    bne     loc_e00536fc\n"
            "    mov     r0, r4\n"
            "    bl      sub_e004baf4\n"
            "    lsls    r0, r0, #0x1f\n"
            "    beq     loc_e00536fc\n"
            "    movw    r2, #0x227\n"
            "    b       loc_e00536f4\n"
            "loc_e00536e6:\n"
            "    mov     r0, r4\n"
            "    bl      sub_e004baf4\n"
            "    lsls    r0, r0, #0x1f\n"
            "    beq     loc_e00536fc\n"
            "    movw    r2, #0x22a\n"
            "loc_e00536f4:\n"
            "    movs    r0, #0\n"
            "    ldr     r1, =0xe005381c\n" //  *"SsStandardCaptureSeq.c"
            "    bl      sub_dffc96f4\n"
            "loc_e00536fc:\n"
            "    BL      capt_seq_hook_raw_here\n"  // +
            "    mov     r0, r4\n"
            "    bl      sub_e004b562\n"
            "    mov     r0, r4\n"
            "    bl      sub_e004b536\n"
            "    cmp     r5, r8\n"
            "    beq     loc_e0053730\n"
            "    bl      sub_e005157e\n"
            "    movw    sb, #0x23a\n"
            "    movs    r1, #4\n"
            "    ldr     r3, =0xe005381c\n" //  *"SsStandardCaptureSeq.c"
            "    movw    r2, #0x3a98\n"
            "    str.w   sb, [sp]\n"
            "    bl      sub_e02f0954\n"
            "    cbz     r0, loc_e0053730\n"
            "    movs    r0, #0\n"
            "    mov     r2, sb\n"
            "    ldr     r1, =0xe005381c\n" //  *"SsStandardCaptureSeq.c"
            "    bl      sub_dffc96f4\n"
            "loc_e0053730:\n"
            "    ldrh    r0, [r7]\n"
            "    sub.w   r1, r0, #0x4000\n"
            "    subs    r1, #0x45\n"
            "    bne     loc_e0053744\n"
            "    movs    r0, #0\n"
            "    bl      sub_e0299fb0\n"
            "    bl      sub_e0299fa6\n"
            "loc_e0053744:\n"
            "    ldr.w   r0, [r7, #0x188]\n"
            "    cbz     r0, loc_e0053754\n"
            "    movs    r2, #1\n"
            "    movs    r1, #0\n"
            "    movs    r0, #0x46\n"
            "    bl      sub_e0299940\n"
            "loc_e0053754:\n"
            "    movs    r1, #2\n"
            "    mov     r2, r4\n"
            "    mov     r0, r6\n"
            "    bl      sub_e004ff4a\n"
            "    ldr     r0, [r7, #0x28]\n"
            "    cbz     r0, loc_e0053776\n"
            "    cmp     r5, r8\n"
            "    beq     loc_e005376a\n"
            "    movs    r1, #1\n"
            "    b       loc_e005376c\n"
            "loc_e005376a:\n"
            "    movs    r1, #0\n"
            "loc_e005376c:\n"
            "    mov     r2, r6\n"
            "    mov     r0, r4\n"
            "    bl      sub_e0053184\n"
            "    b       loc_e0053788\n"
            "loc_e0053776:\n"
            "    cmp     r5, r8\n"
            "    beq     loc_e005377e\n"
            "    movs    r1, #1\n"
            "    b       loc_e0053780\n"
            "loc_e005377e:\n"
            "    movs    r1, #0\n"
            "loc_e0053780:\n"
            "    mov     r2, r6\n"
            "    mov     r0, r4\n"
            "    bl      sub_e005313e\n"
            "loc_e0053788:\n"
            "    add     sp, #0x10\n"
            "    mov     r0, r6\n"
            "    pop.w   {r4, r5, r6, r7, r8, sb, sl, pc}\n"
    );
}
