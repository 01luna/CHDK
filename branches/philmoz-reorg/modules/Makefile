topdir=../

SKIPBUILDRULES=1

override PLATFORM=modules
override PLATFORMSUB=100a

include $(topdir)makefile.inc

OBJ_ISDIGIT=
ifeq ($(GCC_VERSION_MAJOR),3)
    OBJ_ISDIGIT+= $(topdir)lib/libc/issmth.o
endif

CFLAGS+=$(CTHUMB) -mlong-calls
# warning: library order matters!
LDLIBS= -lgcc
LDOPTS=-nostdlib -Wl,--allow-shlib-undefined -Wl,-T,$(topdir)tools/link-boot.ld
LDOPTS+=-Wl,-N,-Ttext,0x0016ee30 -r -Wl,-d

FLTS=fselect.flt edgeovr.flt curves.flt mpopup.flt palette.flt grids.flt mdetect.flt zebra.flt \
     _dng.flt benchm.flt calend.flt 4wins.flt mastmind.flt reversi.flt sokoban.flt _rawop10.flt _rawop12.flt \
     txtread.flt memview.flt modinsp.flt tetris.flt snake.flt sudoku.flt _tbox.flt _osd_le.flt

all: exportlist $(topdir)core/flt.h $(FLTS)

%.o: %.c
	@echo $< \-\> $@
	$(CC) $(CFLAGS) -nostdinc -c -o $@ $<

%.o: games/%.c
	@echo $< \-\> $@
	$(CC) $(CFLAGS) -nostdinc -c -o $@ $<

%.elf:
	@echo \-\> $@
	$(CC) $(CFLAGS) -o $@ -Wl,--start-group $^ $(LDLIBS) -Wl,--end-group $(LDFLAGS) $(LDOPTS)

.dep/%.d: %.c .dep
	$(HOSTCC) $(HOSTCFLAGS) -MM $< > $@.$$$$; \
	    sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ > $@; \
	    rm -f $@.$$$$

%.flt: %.elf
	@echo \-\> $@
#	arm-elf-objdump$(EXE) -d -r -x $< >$<.dumpobj
#	$(topdir)/tools/elf2flt/elf2flt$(EXE) $< $@ -e -f -h -r -s -iexportlist.txt -!$(topdir)/tools/elf2flt/stoplist.txt >$@.dump
	$(topdir)/tools/elf2flt/elf2flt$(EXE) $< $@ -iexportlist.txt -!$(topdir)/tools/elf2flt/stoplist.txt > $(DEVNULL)

raw_merge10.o: raw_merge.c
	@echo $< \-\> $@
	$(CC) $(CFLAGS) -nostdinc -c -DCAM_MODULE_SENSOR_BITS_PER_PIXEL=10 -o $@ $<

raw_merge12.o: raw_merge.c
	@echo $< \-\> $@
	$(CC) $(CFLAGS) -nostdinc -c -DCAM_MODULE_SENSOR_BITS_PER_PIXEL=12 -o $@ $<

nothumb.o: nothumb.c
	@echo $< \-\> $@
	$(CC) $(CFLAGS) -marm -nostdinc -c -o $@ $<

reversebytes.o: reversebytes.S
	@echo $< \-\> $@
	$(CC) $(CFLAGS) -marm -nostdinc -c -o $@ $<

calend.elf: simple_module.o gui_calendar.o
_tbox.elf: gui_tbox.o
benchm.elf: simple_module.o gui_bench.o
memview.elf: gui_debug.o
palette.elf: gui_palette.o
mpopup.elf: gui_mpopup.o
txtread.elf: gui_read.o
edgeovr.elf: edgeoverlay.o bitvector.o $(OBJ_ISDIGIT)
zebra.elf: zebra.o
curves.elf: curves.o
mdetect.elf: motion_detector.o
grids.elf: gui_grid.o
modinsp.elf: module_inspector.o
_dng.elf: dng.o reversebytes.o
_rawop10.elf: raw_merge10.o
_rawop12.elf: raw_merge12.o
_osd_le.elf: gui_osd_edit.o
fselect.elf: gui_fselect.o nothumb.o
#lua.elf: lib_edgeoverlay.o luascript.o $(topdir)lib/lua/liblua.a

4wins.elf: simple_game.o gui_4wins.o
mastmind.elf: simple_game.o gui_mastermind.o
reversi.elf: simple_game.o gui_reversi.o
tetris.elf: simple_game.o gui_tetris.o
snake.elf: simple_game.o gui_snake.o
sokoban.elf: gui_sokoban.o
sudoku.elf: simple_game.o gui_sudoku.o

clean:
	rm -f *.o *.elf.syms *.elf *.flt

distclean: clean
#	rm -f *.flt

exportlist:  $(topdir)core/module_exportlist.c
	@echo $< \-\> $@
	$(topdir)tools/makeexport$(EXE) $(topdir)core/module_exportlist.c $(topdir)core/module_exportlist.h exportlist.txt $(topdir)core/module_hashlist.h

$(topdir)core/flt.h: $(topdir)tools/elf2flt/flt.h
	@echo $< \-\> $@
	@echo "//DO NOT EDIT THIS FILE. This is automatic copy of tools/elf2flt/flt.h" > $(topdir)core/flt.h
	cat $(topdir)tools/elf2flt/flt.h >>$(topdir)core/flt.h

include $(topdir)bottom.inc
